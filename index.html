<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Система управления проектами</title>

		<!-- Firebase SDK -->
		<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
		<script>
			// Firebase конфигурация (обновлено)
			var firebaseConfig = {
				apiKey: 'AIzaSyBI81c5blZotC4zUye0B7zPCEvQ0ji0c1Q',
				authDomain: 'project-24949.firebaseapp.com',
				projectId: 'project-24949',
				storageBucket: 'project-24949.firebasestorage.app',
				messagingSenderId: '658650011107',
				appId: '1:658650011107:web:33669b4d6097381db13cd6',
				measurementId: 'G-GYG6N99CK5',
			}

			// Инициализация Firebase с улучшенной обработкой ошибок
			var db = null
			var isFirebaseAvailable = false

			try {
				console.log('Попытка инициализации Firebase...')
				firebase.initializeApp(firebaseConfig)
				db = firebase.firestore()

				// Тестируем подключение к Firestore
				db.enableNetwork()
					.then(() => {
						console.log('Firebase Firestore подключен успешно')
						isFirebaseAvailable = true
					})
					.catch(error => {
						console.error('Ошибка подключения к Firestore:', error)
						isFirebaseAvailable = false
					})

				console.log('Firebase SDK инициализирован', {
					projectId: firebaseConfig.projectId,
					isFirebaseAvailable,
				})
			} catch (error) {
				console.error('Ошибка инициализации Firebase:', error)
				isFirebaseAvailable = false
				console.log('Firebase недоступен, будет использоваться localStorage')
			}
		</script>

		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					Oxygen, Ubuntu, Cantarell, sans-serif;
				background: #ffffff;
				min-height: 100vh;
				color: #130909;
				padding: 20px;
			}

			.container {
				max-width: 1400px;
				margin: 0 auto;
				animation: fadeIn 0.5s ease-in;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.header {
				background: #f1f1f1;
				border-radius: 15px;
				padding: 30px;
				margin-bottom: 30px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
			}

			.header h1 {
				color: #130909;
				font-size: 2.5em;
				margin-bottom: 10px;
			}

			/* Стили для страницы выбора проектов */
			.projects-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 25px;
				margin-bottom: 30px;
			}

			.project-card {
				background: #f1f1f1;
				border-radius: 15px;
				padding: 30px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
				cursor: pointer;
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				text-align: center;
				position: relative;
				overflow: hidden;
				animation: bounceIn 0.6s ease-out;
			}

			.project-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 5px;
				background: #fc403a;
				transform: translateX(-100%);
				transition: transform 0.4s ease;
			}

			.project-card:hover {
				transform: translateY(-10px) scale(1.05);
				box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
			}

			.project-content {
				padding: 10px;
				cursor: pointer;
			}

			.project-card:hover::before {
				transform: translateX(0);
			}

			.project-card:hover .project-delete {
				opacity: 1;
				transform: scale(1);
			}

			.project-delete {
				position: absolute;
				top: 10px;
				right: 10px;
				width: 35px;
				height: 35px;
				background: #dc3545;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 18px;
				opacity: 0;
				transform: scale(0.8);
				transition: all 0.3s ease;
				cursor: pointer;
				z-index: 10;
			}

			.project-delete:hover {
				background: #c82333;
				transform: scale(1.1);
				box-shadow: 0 5px 15px rgba(0, 53, 69, 0.5);
			}

			.project-color-btn {
				position: absolute;
				top: 10px;
				right: 55px;
				width: 35px;
				height: 35px;
				background: #fc403a;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				color: white;
				font-size: 18px;
				opacity: 0;
				transform: scale(0.8);
				transition: all 0.3s ease;
				cursor: pointer;
				z-index: 10;
			}

			.project-card:hover .project-color-btn {
				opacity: 1;
				transform: scale(1);
			}

			.project-color-btn:hover {
				background: #e63946;
				transform: scale(1.1);
				box-shadow: 0 5px 15px rgba(252, 64, 58, 0.5);
			}

			.project-icon {
				font-size: 3em;
				margin-bottom: 15px;
			}

			.project-name {
				font-size: 1.5em;
				font-weight: 600;
				color: #130909;
				margin-bottom: 10px;
			}

			.project-stats {
				font-size: 0.9em;
				color: #f1f1f1;
			}

			.add-project-card {
				border: 2px dashed #fc403a;
				background: rgba(252, 64, 58, 0.1);
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
			}

			.add-project-card:hover {
				background: rgba(252, 64, 58, 0.2);
			}

			/* Модальное окно для создания проекта */
			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				z-index: 1000;
				animation: fadeIn 0.3s ease;
			}

			.modal-content {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: white;
				padding: 40px;
				border-radius: 15px;
				box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
				max-width: 500px;
				width: 90%;
				animation: slideIn 0.3s ease;
			}

			@keyframes slideIn {
				from {
					transform: translate(-50%, -60%);
					opacity: 0;
				}
				to {
					transform: translate(-50%, -50%);
					opacity: 1;
				}
			}

			.modal-header {
				font-size: 1.8em;
				color: #130909;
				margin-bottom: 20px;
			}

			.modal-input {
				width: 100%;
				padding: 15px;
				border: 2px solid #e0e0e0;
				border-radius: 10px;
				font-size: 16px;
				margin-bottom: 20px;
				transition: border-color 0.3s ease;
			}

			.modal-input:focus {
				outline: none;
				border-color: #fc403a;
			}

			.modal-buttons {
				display: flex;
				gap: 15px;
				justify-content: flex-end;
			}

			.btn {
				padding: 16px 32px;
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
				border: none;
				border-radius: 15px;
				font-size: 16px;
				font-weight: 700;
				cursor: pointer;
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				box-shadow: 0 8px 25px rgba(252, 64, 58, 0.3);
				letter-spacing: 0.8px;
				text-transform: uppercase;
				position: relative;
				overflow: hidden;
			}

			.btn::before {
				content: '';
				position: absolute;
				top: 0;
				left: -100%;
				width: 100%;
				height: 100%;
				background: linear-gradient(
					90deg,
					transparent,
					rgba(255, 255, 255, 0.2),
					transparent
				);
				transition: left 0.5s ease;
			}

			.btn:hover {
				transform: translateY(-4px) scale(1.05);
				box-shadow: 0 15px 45px rgba(252, 64, 58, 0.4);
				background: linear-gradient(135deg, #e63946 0%, #dc3545 100%);
			}

			.btn:hover::before {
				left: 100%;
			}

			.btn-secondary {
				background: #e0e0e0;
				color: #333;
			}

			.btn-secondary:hover {
				background: #d0d0d0;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
			}

			/* Стили для страницы проекта */
			.project-page {
				display: none;
			}

			.back-button {
				display: inline-flex;
				align-items: center;
				gap: 10px;
				margin-bottom: 20px;
				padding: 10px 20px;
				background: #f1f1f1;
				border-radius: 10px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.back-button:hover {
				background: #ffffff;
				transform: translateX(-5px);
			}

			.stats {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
				gap: 20px;
				margin-bottom: 30px;
			}

			.stat-card {
				background: #f1f1f1;
				border-radius: 15px;
				padding: 25px;
				text-align: center;
				box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				animation: bounceIn 0.6s ease-out;
			}

			.stat-card:hover {
				transform: translateY(-8px) scale(1.05);
				box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
			}

			.stat-number {
				font-size: 3em;
				font-weight: bold;
				color: #fc403a;
				margin-bottom: 10px;
			}

			.main-content {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 30px;
				margin-bottom: 30px;
			}

			@media (max-width: 968px) {
				.main-content {
					grid-template-columns: 1fr;
				}
			}

			.section {
				background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
				border-radius: 20px;
				padding: 35px;
				box-shadow: 0 15px 50px rgba(0, 0, 0, 0.08);
				border: 1px solid rgba(252, 64, 58, 0.1);
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				position: relative;
				overflow: hidden;
			}

			.section::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 3px;
				background: linear-gradient(
					90deg,
					#fc403a 0%,
					rgba(252, 64, 58, 0.6) 50%,
					#fc403a 100%
				);
				opacity: 0;
				transition: opacity 0.4s ease;
			}

			.section:hover {
				transform: translateY(-5px) scale(1.01);
				box-shadow: 0 25px 80px rgba(252, 64, 58, 0.15);
				border-color: rgba(252, 64, 58, 0.2);
			}

			.section:hover::before {
				opacity: 1;
			}

			.section h2 {
				color: #130909;
				margin-bottom: 20px;
				font-size: 1.8em;
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.task-form {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
			}

			.task-input {
				flex: 1;
				padding: 16px 24px;
				border: 2px solid #e8e8e8;
				border-radius: 15px;
				font-size: 16px;
				font-weight: 500;
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
				transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
				letter-spacing: 0.3px;
			}

			.task-input:focus {
				outline: none;
				border-color: #fc403a;
				box-shadow: 0 0 0 4px rgba(252, 64, 58, 0.1),
					0 8px 30px rgba(252, 64, 58, 0.15);
				transform: translateY(-3px);
				background: #ffffff;
			}

			.task-list {
				list-style: none;
				max-height: 400px;
				overflow-y: auto;
			}

			.task-item {
				background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
				padding: 20px 25px;
				margin-bottom: 15px;
				border-radius: 15px;
				display: flex;
				flex-direction: column;
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				animation: taskSlideIn 0.5s ease-out;
				border: 1px solid #e8e8e8;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
				transform-origin: left center;
			}

			@keyframes taskSlideIn {
				from {
					opacity: 0;
					transform: translateY(-15px) scale(0.95);
				}
				to {
					opacity: 1;
					transform: translateY(0) scale(1);
				}
			}

			.task-item:hover {
				background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
				transform: translateY(-5px) scale(1.02);
				box-shadow: 0 12px 40px rgba(252, 64, 58, 0.15);
				border-color: rgba(252, 64, 58, 0.2);
			}

			.task-item.completed {
				background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
				opacity: 0.7;
			}

			.task-item.completed .task-text {
				text-decoration: line-through;
				color: #6c757d;
			}

			.task-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
				width: 100%;
			}

			.task-main {
				display: flex;
				align-items: center;
				gap: 15px;
				flex: 1;
			}

			.task-text {
				flex: 1;
				font-weight: 600;
				color: #130909;
				font-size: 16px;
				letter-spacing: 0.3px;
			}

			.task-expand {
				background: none;
				border: none;
				cursor: pointer;
				font-size: 16px;
				color: #fc403a;
				padding: 5px;
				border-radius: 3px;
				transition: all 0.2s ease;
			}

			.task-expand:hover {
				background: rgba(252, 64, 58, 0.1);
			}

			.task-expand.collapsed {
				transform: rotate(-90deg);
			}

			.task-text {
				flex: 1;
			}

			.subtasks-container {
				margin-top: 15px;
				padding-left: 30px;
				border-left: 3px solid #e8e8e8;
				position: relative;
				max-height: 0;
				overflow: hidden;
				opacity: 0;
				transform: translateY(-15px);
				transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
			}

			.subtasks-container::before {
				content: '';
				position: absolute;
				left: -3px;
				top: 0;
				bottom: 0;
				width: 3px;
				background: linear-gradient(
					135deg,
					#fc403a 0%,
					rgba(252, 64, 58, 0.6) 50%,
					#fc403a 100%
				);
				opacity: 0;
				transition: opacity 0.5s ease;
				border-radius: 2px;
			}

			.subtasks-container.show {
				max-height: 2000px;
				opacity: 1;
				transform: translateY(0);
				animation: subtasksExpand 0.6s ease-out;
			}

			@keyframes subtasksExpand {
				from {
					max-height: 0;
					opacity: 0;
					transform: translateY(-15px);
				}
				to {
					max-height: 2000px;
					opacity: 1;
					transform: translateY(0);
				}
			}

			.subtasks-container.show::before {
				opacity: 1;
				animation: gradientGlow 0.8s ease-out;
			}

			@keyframes gradientGlow {
				0% {
					opacity: 0;
					transform: scaleY(0);
				}
				50% {
					opacity: 0.8;
					transform: scaleY(1.1);
				}
				100% {
					opacity: 1;
					transform: scaleY(1);
				}
			}

			.subtask-item {
				background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
				margin-bottom: 10px;
				border-radius: 12px;
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				border: 1px solid #e8e8e8;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
				transform-origin: left center;
				animation: subtaskSlideIn 0.5s ease-out;
			}

			@keyframes subtaskSlideIn {
				from {
					opacity: 0;
					transform: translateX(-20px) scale(0.95);
				}
				to {
					opacity: 1;
					transform: translateX(0) scale(1);
				}
			}

			.subtask-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 14px 18px;
			}

			.subtask-main {
				display: flex;
				align-items: center;
				gap: 12px;
				flex: 1;
			}

			.subtask-text {
				flex: 1;
				font-weight: 500;
				color: #130909;
				letter-spacing: 0.3px;
			}

			.subtask-item:hover {
				background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
				transform: translateX(8px) scale(1.02);
				box-shadow: 0 8px 25px rgba(252, 64, 58, 0.15);
				border-color: rgba(252, 64, 58, 0.2);
			}

			.subtask-item.completed {
				background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
				opacity: 0.7;
			}

			.subtask-item.completed .subtask-text {
				opacity: 0.6;
				text-decoration: line-through;
				color: #6c757d;
			}

			.task-expand,
			.subtask-expand {
				background: linear-gradient(
					135deg,
					rgba(252, 64, 58, 0.1) 0%,
					rgba(252, 64, 58, 0.05) 100%
				);
				border: 1px solid rgba(252, 64, 58, 0.2);
				font-size: 14px;
				color: #fc403a;
				cursor: pointer;
				padding: 6px;
				border-radius: 8px;
				transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				width: 24px;
				height: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 2px 8px rgba(252, 64, 58, 0.1);
			}

			.task-expand:hover,
			.subtask-expand:hover {
				background: linear-gradient(
					135deg,
					rgba(252, 64, 58, 0.2) 0%,
					rgba(252, 64, 58, 0.1) 100%
				);
				transform: scale(1.1);
				box-shadow: 0 4px 15px rgba(252, 64, 58, 0.25);
				border-color: rgba(252, 64, 58, 0.4);
			}

			.task-expand.collapsed,
			.subtask-expand.collapsed {
				transform: rotate(-90deg);
			}

			.task-expand.collapsed:hover,
			.subtask-expand.collapsed:hover {
				transform: rotate(-90deg) scale(1.1);
			}

			.task-actions .task-btn {
				font-size: 12px;
				padding: 6px 12px;
				margin: 0 3px;
			}

			.subtask-item .task-actions .task-btn {
				font-size: 11px;
				padding: 5px 10px;
			}

			.subtask-form {
				display: none;
				gap: 12px;
				margin-top: 12px;
				padding: 16px 20px;
				background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
				border-radius: 12px;
				border: 2px solid #e8e8e8;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
				animation: formSlideIn 0.3s ease-out;
			}

			@keyframes formSlideIn {
				from {
					opacity: 0;
					transform: translateY(-10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.subtask-input {
				flex: 1;
				padding: 12px 16px;
				border: 2px solid #e0e0e0;
				border-radius: 10px;
				font-size: 15px;
				font-weight: 500;
				color: #130909;
				background: #ffffff;
				transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
			}

			.subtask-input:focus {
				outline: none;
				border-color: #fc403a;
				box-shadow: 0 0 0 3px rgba(252, 64, 58, 0.1);
				transform: translateY(-2px);
			}

			.add-subtask-btn {
				padding: 12px 18px;
				background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
				color: white;
				border: none;
				border-radius: 10px;
				cursor: pointer;
				font-weight: 600;
				font-size: 14px;
				transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
				letter-spacing: 0.5px;
			}

			.add-subtask-btn:hover {
				background: linear-gradient(135deg, #218838 0%, #1ea086 100%);
				transform: translateY(-2px) scale(1.05);
				box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
			}

			.task-actions {
				display: flex;
				gap: 12px;
				align-items: center;
			}

			.task-btn {
				padding: 8px 16px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 13px;
				font-weight: 600;
				letter-spacing: 0.5px;
				transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.complete-btn {
				background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
				color: white;
			}

			.complete-btn:hover {
				background: linear-gradient(135deg, #218838 0%, #1ea086 100%);
				transform: translateY(-2px) scale(1.05);
				box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
			}

			.edit-btn {
				background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
				color: white;
			}

			.edit-btn:hover {
				background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
				transform: translateY(-2px) scale(1.05);
				box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
			}

			.delete-btn {
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
			}

			.delete-btn:hover {
				background: linear-gradient(135deg, #e63946 0%, #dc3545 100%);
				transform: translateY(-2px) scale(1.05);
				box-shadow: 0 4px 15px rgba(252, 64, 58, 0.3);
			}

			/* Стили для чекбоксов */
			.task-checkbox {
				width: 18px;
				height: 18px;
				cursor: pointer;
				accent-color: #fc403a;
				border: 2px solid #e0e0e0;
				border-radius: 4px;
				transition: all 0.3s ease;
			}

			.task-checkbox:hover {
				border-color: #fc403a;
				transform: scale(1.1);
			}

			.task-checkbox:checked {
				background-color: #fc403a;
				border-color: #fc403a;
			}

			/* Стили для заметок */
			.notes-form {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
			}

			.notes-input {
				flex: 1;
				padding: 12px 20px;
				border: 2px solid #e0e0e0;
				border-radius: 10px;
				font-size: 16px;
				transition: border-color 0.3s ease;
			}

			.notes-input:focus {
				outline: none;
				border-color: #fc403a;
			}

			.notes-list {
				max-height: 400px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				gap: 10px;
			}

			.note-item {
				background: #fff8dc;
				padding: 15px 20px;
				border-radius: 10px;
				border-left: 4px solid #ffd700;
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				animation: fadeInUp 0.5s ease-out;
				transform-origin: left center;
			}

			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.note-item:hover {
				transform: translateX(10px) scale(1.02);
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
				background: #fff5b4;
			}

			.note-text {
				margin-bottom: 8px;
				color: #130909;
			}

			.note-date {
				font-size: 0.8em;
				color: #f1f1f1;
				font-style: italic;
			}

			.note-actions {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-top: 10px;
			}

			.note-btn {
				padding: 5px 15px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				font-size: 14px;
				transition: all 0.2s ease;
				background: #fc403a;
				color: white;
			}

			.note-btn:hover {
				background: #e63946;
				transform: scale(1.05);
			}

			.progress-section {
				grid-column: 1 / -1;
			}

			.progress-bars {
				display: grid;
				gap: 20px;
			}

			.progress-item {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 10px;
			}

			.progress-header {
				display: flex;
				justify-content: space-between;
				margin-bottom: 10px;
			}

			.progress-bar {
				width: 100%;
				height: 20px;
				background: #e0e0e0;
				border-radius: 10px;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				background: #fc403a;
				border-radius: 10px;
				transition: width 0.5s ease;
				position: relative;
				overflow: hidden;
			}

			.progress-fill::after {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				background: linear-gradient(
					90deg,
					transparent,
					rgba(255, 255, 255, 0.3),
					transparent
				);
				animation: shimmer 2s infinite;
			}

			@keyframes shimmer {
				from {
					transform: translateX(-100%);
				}
				to {
					transform: translateX(100%);
				}
			}

			.save-indicator {
				position: fixed;
				bottom: 20px;
				right: 20px;
				background: #28a745;
				color: white;
				padding: 15px 25px;
				border-radius: 10px;
				opacity: 0;
				transform: translateY(20px);
				transition: all 0.3s ease;
				box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
			}

			.save-indicator.show {
				opacity: 1;
				transform: translateY(0);
			}

			.connection-status {
				position: fixed;
				top: 20px;
				right: 20px;
				background: #17a2b8;
				color: white;
				padding: 10px 20px;
				border-radius: 25px;
				font-size: 14px;
				opacity: 0;
				transform: translateY(-20px);
				transition: all 0.3s ease;
				z-index: 1001;
			}

			.connection-status.show {
				opacity: 1;
				transform: translateY(0);
			}

			.connection-status.online {
				background: #28a745;
			}

			.connection-status.offline {
				background: #dc3545;
			}

			.delete-project-btn {
				background: #fc403a;
				margin-left: auto;
			}

			.delete-project-btn:hover {
				background: #e63946;
			}

			/* Scrollbar styling */
			::-webkit-scrollbar {
				width: 8px;
			}

			::-webkit-scrollbar-track {
				background: #f1f1f1;
				border-radius: 10px;
			}

			::-webkit-scrollbar-thumb {
				background: #888;
				border-radius: 10px;
			}

			::-webkit-scrollbar-thumb:hover {
				background: #555;
			}

			@keyframes bounceIn {
				0% {
					transform: scale(0.3);
					opacity: 0;
				}
				50% {
					transform: scale(1.05);
				}
				70% {
					transform: scale(0.9);
				}
				100% {
					transform: scale(1);
					opacity: 1;
				}
			}

			.subtask-btn {
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
			}

			.subtask-btn:hover {
				background: linear-gradient(135deg, #e63946 0%, #dc3545 100%);
				transform: translateY(-2px) scale(1.05);
				box-shadow: 0 4px 15px rgba(252, 64, 58, 0.3);
			}

			.subtask-count {
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
				font-size: 10px;
				font-weight: 700;
				padding: 2px 6px;
				border-radius: 8px;
				margin-left: 4px;
				letter-spacing: 0.5px;
				box-shadow: 0 2px 6px rgba(252, 64, 58, 0.3);
				animation: pulse 2s infinite;
			}

			@keyframes pulse {
				0% {
					box-shadow: 0 2px 6px rgba(252, 64, 58, 0.3);
				}
				50% {
					box-shadow: 0 2px 6px rgba(252, 64, 58, 0.6);
				}
				100% {
					box-shadow: 0 2px 6px rgba(252, 64, 58, 0.3);
				}
			}

			.notification {
				position: fixed;
				top: 20px;
				right: 20px;
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
				padding: 12px 20px;
				border-radius: 8px;
				box-shadow: 0 4px 15px rgba(252, 64, 58, 0.3);
				z-index: 10000;
				font-weight: 500;
				transform: translateX(100%);
				transition: transform 0.3s ease;
			}

			.loading-indicator {
				position: fixed;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: rgba(19, 9, 9, 0.9);
				color: white;
				padding: 20px 30px;
				border-radius: 10px;
				z-index: 10000;
				font-weight: 500;
				backdrop-filter: blur(10px);
			}

			/* Стили для гипотез */
			.hypotheses-section {
				background: rgba(255, 255, 255, 0.95);
				border: 2px solid #f1f1f1;
				border-radius: 15px;
				padding: 20px;
				margin-bottom: 30px;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
				backdrop-filter: blur(10px);
			}

			.hypotheses-section h3 {
				margin: 0 0 15px 0;
				color: #130909;
				font-size: 18px;
				font-weight: 600;
			}

			.hypotheses-form {
				display: flex;
				gap: 10px;
				margin-bottom: 15px;
			}

			.hypotheses-input {
				flex: 1;
				padding: 12px 20px;
				border: 2px solid #e0e0e0;
				border-radius: 10px;
				font-size: 16px;
				transition: border-color 0.3s ease;
				background: white;
			}

			.hypotheses-input:focus {
				outline: none;
				border-color: #fc403a;
			}

			.btn-hypothesis {
				background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
				color: white;
				padding: 12px 20px;
				border: none;
				border-radius: 10px;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.btn-hypothesis:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 15px rgba(252, 64, 58, 0.3);
			}

			.hypotheses-list {
				max-height: 200px;
				overflow-y: auto;
				border: 1px solid #e0e0e0;
				border-radius: 10px;
				background: white;
			}

			.hypothesis-item {
				padding: 12px 15px;
				border-bottom: 1px solid #f1f1f1;
				transition: background-color 0.2s ease;
			}

			.hypothesis-item:last-child {
				border-bottom: none;
			}

			.hypothesis-item:hover {
				background-color: #f8f9fa;
			}

			.hypothesis-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 5px;
			}

			.hypothesis-text {
				flex: 1;
				color: #130909;
				font-weight: 500;
			}

			.hypothesis-delete-btn {
				background: #fc403a;
				color: white;
				border: none;
				border-radius: 50%;
				width: 24px;
				height: 24px;
				cursor: pointer;
				font-size: 16px;
				line-height: 1;
				transition: all 0.2s ease;
			}

			.hypothesis-delete-btn:hover {
				background: #e63946;
				transform: scale(1.1);
			}

			.hypothesis-date {
				font-size: 12px;
				color: #666;
			}

			/* Стили для заметок */
			.note-item {
				background: rgba(255, 255, 255, 0.9);
				border: 1px solid #e0e0e0;
				border-radius: 10px;
				padding: 15px;
				margin-bottom: 10px;
				transition: all 0.3s ease;
			}

			.note-item:hover {
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				transform: translateY(-1px);
			}

			.note-content {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 8px;
			}

			.note-text {
				flex: 1;
				color: #130909;
				line-height: 1.5;
				margin-right: 10px;
			}

			.note-delete-btn {
				background: #fc403a;
				color: white;
				border: none;
				border-radius: 50%;
				width: 24px;
				height: 24px;
				cursor: pointer;
				font-size: 16px;
				line-height: 1;
				transition: all 0.2s ease;
			}

			.note-delete-btn:hover {
				background: #e63946;
				transform: scale(1.1);
			}

			.note-date {
				font-size: 12px;
				color: #666;
			}

			/* Стили для выбора цветов */
			.color-picker-content {
				text-align: center;
			}

			.color-options {
				display: grid;
				grid-template-columns: repeat(4, 1fr);
				gap: 15px;
				margin: 20px 0;
				padding: 0 20px;
			}

			.color-option {
				width: 50px;
				height: 50px;
				border: 3px solid transparent;
				border-radius: 50%;
				cursor: pointer;
				transition: all 0.3s ease;
				position: relative;
			}

			.color-option:hover {
				transform: scale(1.1);
				border-color: #130909;
			}

			.color-option.selected {
				border-color: #130909;
				transform: scale(1.15);
			}

			.color-option.selected::after {
				content: '✓';
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: white;
				font-weight: bold;
				font-size: 18px;
				text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
			}

			/* Адаптивные стили для мобильных устройств */
			@media (max-width: 768px) {
				.container {
					padding: 10px;
				}

				.header h1 {
					font-size: 24px;
				}

				.header p {
					font-size: 14px;
				}

				.stats {
					grid-template-columns: repeat(2, 1fr);
					gap: 10px;
				}

				.stat-card {
					padding: 15px;
				}

				.stat-number {
					font-size: 20px;
				}

				.projects-grid {
					grid-template-columns: 1fr;
					gap: 15px;
				}

				.project-card {
					padding: 20px;
				}

				.main-content {
					grid-template-columns: 1fr;
					gap: 20px;
				}

				.task-form {
					flex-direction: column;
					gap: 10px;
				}

				.task-form .task-input {
					margin-right: 0;
				}

				.notes-form {
					flex-direction: column;
					gap: 10px;
				}

				.notes-form .notes-input {
					margin-right: 0;
				}

				.hypotheses-section {
					padding: 15px;
					margin-bottom: 20px;
				}

				.hypotheses-form {
					flex-direction: column;
					gap: 10px;
				}

				.hypotheses-list {
					max-height: 150px;
				}

				.color-options {
					grid-template-columns: repeat(3, 1fr);
					gap: 10px;
				}

				.color-option {
					width: 40px;
					height: 40px;
				}

				.project-color-btn {
					right: 50px;
					width: 30px;
					height: 30px;
					font-size: 14px;
				}

				.project-delete {
					width: 30px;
					height: 30px;
					font-size: 14px;
				}

				.task-actions {
					flex-wrap: wrap;
					gap: 8px;
				}

				.task-btn {
					font-size: 12px;
					padding: 8px 12px;
				}

				.modal-content {
					margin: 20px;
					width: auto;
					max-width: none;
				}

				.modal-buttons {
					flex-direction: column;
					gap: 10px;
				}

				.progress-section {
					padding: 15px;
				}

				.progress-section h2 {
					flex-direction: column;
					gap: 10px;
					align-items: flex-start;
				}

				.delete-project-btn {
					align-self: stretch;
				}

				.back-button {
					margin-bottom: 15px;
				}

				.connection-status {
					bottom: 60px;
					font-size: 12px;
					padding: 8px 12px;
				}

				.save-indicator {
					bottom: 20px;
					font-size: 12px;
					padding: 8px 12px;
				}

				.notification {
					right: 10px;
					left: 10px;
					top: 10px;
					transform: translateY(-100%);
					transition: transform 0.3s ease;
				}
			}

			@media (max-width: 480px) {
				.container {
					padding: 5px;
				}

				.header h1 {
					font-size: 20px;
				}

				.stats {
					grid-template-columns: 1fr;
				}

				.task-content {
					padding: 10px;
				}

				.task-main {
					flex-direction: column;
					align-items: flex-start;
					gap: 8px;
				}

				.task-actions {
					justify-content: flex-start;
					width: 100%;
				}

				.task-btn {
					flex: 1;
					min-width: 0;
				}

				.subtask-content {
					padding: 8px;
				}

				.modal-content {
					margin: 10px;
				}

				.progress-section {
					padding: 10px;
				}
			}

			/* Стили для авторизации */
			.auth-screen {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100vh;
				background: linear-gradient(135deg, #fc403a 0%, #130909 100%);
				display: flex;
				justify-content: center;
				align-items: center;
				z-index: 9999;
				opacity: 1;
				transition: opacity 0.5s ease;
			}

			.auth-screen.fade-out {
				opacity: 0;
				pointer-events: none;
			}

			.auth-container {
				width: 100%;
				max-width: 450px;
				padding: 20px;
			}

			.auth-card {
				background: rgba(255, 255, 255, 0.95);
				backdrop-filter: blur(20px);
				border-radius: 20px;
				padding: 40px;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
				animation: slideInUp 0.6s ease-out;
				position: relative;
				overflow: hidden;
			}

			.auth-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 4px;
				background: linear-gradient(90deg, #fc403a, #ff6b6b, #fc403a);
				background-size: 200% 100%;
				animation: shimmer 2s infinite;
			}

			@keyframes slideInUp {
				from {
					opacity: 0;
					transform: translateY(50px) scale(0.9);
				}
				to {
					opacity: 1;
					transform: translateY(0) scale(1);
				}
			}

			@keyframes shimmer {
				0% {
					background-position: -200% 0;
				}
				100% {
					background-position: 200% 0;
				}
			}

			.auth-header {
				text-align: center;
				margin-bottom: 30px;
			}

			.auth-header h1 {
				color: #130909;
				font-size: 2rem;
				margin-bottom: 10px;
				font-weight: 700;
			}

			.auth-header p {
				color: #666;
				font-size: 1rem;
			}

			.auth-form {
				display: flex;
				flex-direction: column;
				gap: 20px;
			}

			.auth-tabs {
				display: flex;
				background: #f8f9fa;
				border-radius: 12px;
				padding: 4px;
				margin-bottom: 10px;
			}

			.auth-tab {
				flex: 1;
				padding: 12px 20px;
				border: none;
				background: transparent;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 600;
				transition: all 0.3s ease;
				color: #666;
			}

			.auth-tab.active {
				background: white;
				color: #fc403a;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.auth-tab:hover:not(.active) {
				color: #fc403a;
				background: rgba(252, 64, 58, 0.1);
			}

			.registered-users {
				background: #f8f9fa;
				border-radius: 12px;
				padding: 15px;
				margin-top: 10px;
			}

			.users-list {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
			}

			.user-chip {
				background: white;
				border: 1px solid #e0e0e0;
				border-radius: 20px;
				padding: 5px 12px;
				font-size: 0.8rem;
				color: #666;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.user-chip:hover {
				border-color: #fc403a;
				color: #fc403a;
				transform: translateY(-1px);
			}

			.input-group {
				position: relative;
			}

			.input-group label {
				display: block;
				margin-bottom: 8px;
				color: #130909;
				font-weight: 600;
				font-size: 0.9rem;
			}

			.auth-input {
				width: 100%;
				padding: 15px 20px;
				border: 2px solid #e0e0e0;
				border-radius: 12px;
				font-size: 1rem;
				color: #130909;
				background: #fafafa;
				transition: all 0.3s ease;
				outline: none;
				font-weight: 500;
			}

			.auth-input::placeholder {
				color: #999;
				opacity: 1;
			}

			.auth-input:focus {
				border-color: #fc403a;
				background: white;
				color: #130909;
				box-shadow: 0 0 0 3px rgba(252, 64, 58, 0.1);
				transform: translateY(-2px);
			}

			/* Стили для автозаполнения браузера */
			.auth-input:-webkit-autofill,
			.auth-input:-webkit-autofill:hover,
			.auth-input:-webkit-autofill:focus {
				-webkit-text-fill-color: #130909 !important;
				-webkit-box-shadow: 0 0 0px 1000px #fafafa inset !important;
				transition: background-color 5000s ease-in-out 0s !important;
			}

			.auth-input:-webkit-autofill:focus {
				-webkit-box-shadow: 0 0 0px 1000px white inset !important;
			}

			.auth-input:invalid {
				border-color: #dc3545;
				animation: shake 0.5s ease-in-out;
			}

			@keyframes shake {
				0%,
				100% {
					transform: translateX(0);
				}
				25% {
					transform: translateX(-5px);
				}
				75% {
					transform: translateX(5px);
				}
			}

			.input-error {
				color: #dc3545;
				font-size: 0.8rem;
				margin-top: 5px;
				opacity: 0;
				transform: translateY(-10px);
				transition: all 0.3s ease;
				min-height: 1.2em;
			}

			.input-error.show {
				opacity: 1;
				transform: translateY(0);
			}

			.password-requirements {
				margin-top: 5px;
				opacity: 0.7;
			}

			.password-requirements small {
				color: #666;
				font-size: 0.75rem;
				line-height: 1.3;
			}

			.auth-field {
				margin-bottom: 20px;
			}

			.auth-field label {
				display: block;
				margin-bottom: 8px;
				color: #130909;
				font-weight: 600;
				font-size: 0.9rem;
			}

			.auth-field input {
				width: 100%;
				padding: 15px 20px;
				border: 2px solid #e0e0e0;
				border-radius: 12px;
				font-size: 1rem;
				color: #130909;
				background: #fafafa;
				transition: all 0.3s ease;
				outline: none;
				font-weight: 500;
			}

			.auth-field input::placeholder {
				color: #999;
				opacity: 1;
			}

			.auth-field input:focus {
				border-color: #fc403a;
				background: white;
				color: #130909;
				box-shadow: 0 0 0 3px rgba(252, 64, 58, 0.1);
				transform: translateY(-2px);
			}

			/* Стили для автозаполнения браузера */
			.auth-field input:-webkit-autofill,
			.auth-field input:-webkit-autofill:hover,
			.auth-field input:-webkit-autofill:focus {
				-webkit-text-fill-color: #130909 !important;
				-webkit-box-shadow: 0 0 0px 1000px #fafafa inset !important;
				transition: background-color 5000s ease-in-out 0s !important;
			}

			.auth-field input:-webkit-autofill:focus {
				-webkit-box-shadow: 0 0 0px 1000px white inset !important;
			}

			.field-error {
				color: #dc3545;
				font-size: 0.8rem;
				margin-top: 5px;
				opacity: 0;
				transition: all 0.3s ease;
			}

			.field-error.show {
				opacity: 1;
			}

			.auth-button {
				background: linear-gradient(135deg, #fc403a, #ff6b6b);
				color: white;
				border: none;
				padding: 15px 30px;
				border-radius: 12px;
				font-size: 1.1rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				position: relative;
				overflow: hidden;
				margin-top: 10px;
			}

			.auth-button:hover:not(:disabled) {
				transform: translateY(-2px);
				box-shadow: 0 10px 25px rgba(252, 64, 58, 0.3);
			}

			.auth-button:active {
				transform: translateY(0);
			}

			.auth-button:disabled {
				opacity: 0.7;
				cursor: not-allowed;
				transform: none;
			}

			.btn-text {
				transition: opacity 0.3s ease;
			}

			.btn-loader {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 20px;
				height: 20px;
				border: 2px solid rgba(255, 255, 255, 0.3);
				border-top: 2px solid white;
				border-radius: 50%;
				opacity: 0;
				transform: translate(-50%, -50%);
				transition: opacity 0.3s ease;
			}

			.auth-button.loading .btn-text {
				opacity: 0;
			}

			.auth-button.loading .btn-loader {
				opacity: 1;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% {
					transform: translate(-50%, -50%) rotate(0deg);
				}
				100% {
					transform: translate(-50%, -50%) rotate(360deg);
				}
			}

			.auth-error {
				background: #fee;
				color: #dc3545;
				padding: 15px;
				border-radius: 8px;
				font-size: 0.9rem;
				text-align: center;
				opacity: 0;
				transform: scale(0.9);
				transition: all 0.3s ease;
				border-left: 4px solid #dc3545;
			}

			.auth-error.show {
				opacity: 1;
				transform: scale(1);
			}

			.header-actions {
				position: absolute;
				top: 20px;
				right: 20px;
				display: flex;
				gap: 10px;
			}

			.logout-btn,
			.admin-btn {
				background: #dc3545;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 0.9rem;
				transition: all 0.3s ease;
			}

			.admin-btn {
				background: #007bff;
			}

			.logout-btn:hover {
				background: #c82333;
				transform: translateY(-2px);
			}

			.admin-btn:hover {
				background: #0056b3;
				transform: translateY(-2px);
			}

			/* Анимация для неправильного ввода */
			.auth-card.error {
				animation: errorShake 0.6s ease-in-out;
			}

			@keyframes errorShake {
				0%,
				100% {
					transform: translateX(0);
				}
				20% {
					transform: translateX(-10px);
				}
				40% {
					transform: translateX(10px);
				}
				60% {
					transform: translateX(-8px);
				}
				80% {
					transform: translateX(8px);
				}
			}

			/* Мобильная адаптация для авторизации */
			@media (max-width: 480px) {
				.auth-container {
					padding: 15px;
				}

				.auth-card {
					padding: 30px 25px;
				}

				.auth-header h1 {
					font-size: 1.6rem;
				}

				.auth-input {
					padding: 12px 15px;
					color: #130909;
					font-weight: 500;
				}

				.auth-button {
					padding: 12px 25px;
				}
			}

			/* Админ-панель */
			.admin-panel {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				z-index: 1000;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.admin-content {
				background: white;
				border-radius: 20px;
				padding: 30px;
				max-width: 900px;
				width: 90%;
				max-height: 90%;
				overflow-y: auto;
				box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
			}

			.admin-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 30px;
				border-bottom: 2px solid #f0f0f0;
				padding-bottom: 15px;
			}

			.admin-header h2 {
				color: #130909;
				margin: 0;
			}

			.close-admin {
				background: #dc3545;
				color: white;
				border: none;
				width: 35px;
				height: 35px;
				border-radius: 50%;
				cursor: pointer;
				font-size: 1.2rem;
				transition: all 0.3s ease;
			}

			.close-admin:hover {
				background: #c82333;
				transform: scale(1.1);
			}

			.admin-stats {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 20px;
				margin-bottom: 30px;
			}

			.stat-card {
				background: linear-gradient(135deg, #fc403a, #ff6b6b);
				color: white;
				padding: 25px;
				border-radius: 15px;
				text-align: center;
				box-shadow: 0 10px 25px rgba(252, 64, 58, 0.3);
			}

			.stat-card h3 {
				margin: 0 0 10px 0;
				font-size: 0.9rem;
				opacity: 0.9;
			}

			.stat-card span {
				font-size: 2rem;
				font-weight: bold;
			}

			.users-management {
				margin-bottom: 30px;''
			}

			.users-management h3 {
				color: #130909;
				margin-bottom: 15px;
			}

			.users-table {
				border: 1px solid #e0e0e0;
				border-radius: 10px;
				overflow: hidden;
			}

			.table-header {
				background: #f8f9fa;
				display: grid;
				grid-template-columns: 2fr 1.5fr 1fr 1fr 1.5fr;
				gap: 15px;
				padding: 15px;
				font-weight: bold;
				color: #130909;
			}

			.table-body {
				max-height: 300px;
				overflow-y: auto;
			}

			.user-row {
				display: grid;
				grid-template-columns: 2fr 1.5fr 1fr 1fr 1.5fr;
				gap: 15px;
				padding: 15px;
				border-top: 1px solid #e0e0e0;
				align-items: center;
			}

			.user-row:hover {
				background: #f8f9fa;
			}

			.user-email {
				font-weight: 500;
				color: #130909;
			}

			.user-date {
				color: #666;
				font-size: 0.9rem;
			}

			.user-projects {
				color: #007bff;
				font-weight: bold;
			}

			.user-status {
				font-weight: bold;
				padding: 4px 8px;
				border-radius: 12px;
				font-size: 0.8rem;
				text-align: center;
			}

			.status-active {
				background: #d4edda;
				color: #155724;
			}

			.status-blocked {
				background: #f8d7da;
				color: #721c24;
			}

			.user-actions {
				display: flex;
				gap: 5px;
				flex-wrap: wrap;
			}

			.btn-small {
				padding: 5px 10px;
				font-size: 0.8rem;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.btn-view {
				background: #007bff;
				color: white;
			}

			.btn-view:hover {
				background: #0056b3;
			}

			.btn-delete {
				background: #dc3545;
				color: white;
			}

			.btn-delete:hover {
				background: #c82333;
			}

			.btn-block {
				background: #ffc107;
				color: #212529;
			}

			.btn-block:hover {
				background: #e0a800;
			}

			.btn-unblock {
				background: #28a745;
				color: white;
			}

			.btn-unblock:hover {
				background: #1e7e34;
			}

			.system-management h3 {
				color: #130909;
				margin-bottom: 15px;
			}

			.system-actions {
				display: flex;
				gap: 15px;
				flex-wrap: wrap;
			}

			.btn-info {
				background: #17a2b8;
				color: white;
			}

			.btn-info:hover {
				background: #138496;
			}

			.btn-warning {
				background: #ffc107;
				color: #212529;
			}

			.btn-warning:hover {
				background: #e0a800;
			}

			.btn-danger {
				background: #dc3545;
				color: white;
			}

			.btn-danger:hover {
				background: #c82333;
			}

			/* ...existing code... */
		</style>
	</head>
	<body>
		<!-- Экран авторизации -->
		<div id="authScreen" class="auth-screen">
			<div class="auth-container">
				<div class="auth-card">
					<div class="auth-header">
						<h1>🚀 Система управления проектами</h1>
						<p>Войдите в свой аккаунт</p>
					</div>

					<div class="auth-tabs">
						<button
							type="button"
							class="auth-tab active"
							id="loginTab"
							onclick="switchTab('login')"
						>
							Вход
						</button>
						<button
							type="button"
							class="auth-tab"
							id="registerTab"
							onclick="switchTab('register')"
						>
							Регистрация
						</button>
					</div>

					<form id="authForm" class="auth-form">
						<div class="auth-field">
							<label for="email">Email</label>
							<input
								type="email"
								id="email"
								placeholder="example@mail.com"
								required
							/>
							<div class="field-error" id="emailError"></div>
						</div>
						<div class="auth-field">
							<label for="password">Пароль</label>
							<input
								type="password"
								id="password"
								placeholder="Введите пароль"
								required
							/>
							<div
								class="password-requirements"
								id="passwordRequirements"
								style="display: none"
							>
								<small>
									Требования: минимум 8 символов, одна заглавная буква, минимум
									одна цифра, минимум один специальный символ (!@#$%^&* и т.д.)
								</small>
							</div>
							<div class="field-error" id="passwordError"></div>
						</div>

						<div
							class="auth-field"
							id="confirmPasswordField"
							style="display: none"
						>
							<label for="confirmPassword">Подтвердите пароль</label>
							<input
								type="password"
								id="confirmPassword"
								placeholder="Повторите пароль"
							/>
							<div class="field-error" id="confirmPasswordError"></div>
						</div>

						<button type="submit" class="auth-button" id="authBtn">
							<span class="btn-text">Войти</span>
							<div class="btn-loader"></div>
						</button>

						<div class="auth-error" id="authError"></div>
					</form>
				</div>
			</div>
		</div>

		<!-- Основное приложение -->
		<div class="container" id="mainApp" style="display: none">
			<!-- Страница выбора проектов -->
			<div id="projectsListPage">
				<div class="header">
					<h1>🚀 Мои проекты</h1>
					<p>Выберите проект или создайте новый</p>
					<div class="header-actions">
						<button
							class="admin-btn"
							id="adminBtn"
							onclick="showAdminPanel()"
							style="display: none"
						>
							👥 Управление
						</button>
						<button class="logout-btn" onclick="logout()">Выйти</button>
					</div>
				</div>

				<!-- Окно гипотез -->
				<div class="hypotheses-section">
					<h3>💡 Гипотезы</h3>
					<div class="hypotheses-form">
						<input
							type="text"
							class="hypotheses-input"
							id="hypothesisInput"
							placeholder="Введите гипотезу..."
							onkeypress="if(event.key==='Enter'){addHypothesis().catch(console.error)}"
						/>
						<button
							class="btn btn-hypothesis"
							onclick="addHypothesis().catch(console.error)"
						>
							Добавить
						</button>
					</div>
					<div class="hypotheses-list" id="hypothesesList"></div>
				</div>

				<div class="projects-grid" id="projectsGrid">
					<!-- Карточки проектов будут добавлены динамически -->
					<div
						class="project-card add-project-card"
						onclick="showCreateProjectModal()"
					>
						<div class="project-icon">➕</div>
						<div class="project-name">Создать новый проект</div>
					</div>
				</div>
			</div>

			<!-- Страница проекта -->
			<div id="projectPage" class="project-page">
				<div class="back-button" onclick="showProjectsList()">
					<span>← Вернуться к проектам</span>
				</div>

				<div class="header">
					<h1>📊 <span id="projectTitle">Панель управления проектом</span></h1>
					<p>Управление задачами и прогрессом</p>
				</div>

				<div class="stats">
					<div class="stat-card">
						<div class="stat-number" id="totalTasks">0</div>
						<div>Всего задач</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="completedTasks">0</div>
						<div>Выполнено</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="pendingTasks">0</div>
						<div>В работе</div>
					</div>
					<div class="stat-card">
						<div class="stat-number" id="completionRate">0%</div>
						<div>Прогресс</div>
					</div>
				</div>

				<div class="main-content">
					<div class="section">
						<h2>📝 Список задач</h2>
						<div class="task-form">
							<input
								type="text"
								class="task-input"
								id="taskInput"
								placeholder="Введите новую задачу..."
								onkeypress="if(event.key==='Enter'){addTask()}"
							/>
							<button class="btn" onclick="addTask()">Добавить в работу</button>
						</div>
						<ul class="task-list" id="taskList"></ul>
					</div>

					<div class="section">
						<h2>📋 Заметки проекта</h2>
						<div class="notes-form">
							<input
								type="text"
								class="notes-input"
								id="notesInput"
								placeholder="Введите заметку..."
								onkeypress="if(event.key==='Enter'){addNote()}"
							/>
							<button class="btn" onclick="addNote()">Добавить заметку</button>
						</div>
						<div class="notes-list" id="notesList"></div>
					</div>
				</div>

				<div class="section progress-section">
					<h2>
						📈 Прогресс по проекту
						<button class="btn delete-project-btn" onclick="deleteProject()">
							Удалить проект
						</button>
					</h2>
					<div class="progress-bars">
						<div class="progress-item">
							<div class="progress-header">
								<span>Выполнение задач</span>
								<span id="progressText">0%</span>
							</div>
							<div class="progress-bar">
								<div class="progress-fill" id="progressFill"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно для создания проекта -->
		<div id="createProjectModal" class="modal">
			<div class="modal-content">
				<h2 class="modal-header">Создание нового проекта</h2>
				<input
					type="text"
					class="modal-input"
					id="newProjectName"
					placeholder="Введите название проекта..."
					autocomplete="off"
					autofocus
				/>
				<div class="modal-buttons">
					<button class="btn btn-secondary" onclick="hideCreateProjectModal()">
						Отмена
					</button>
					<button class="btn" onclick="createProject()">Создать</button>
				</div>
			</div>
		</div>

		<div class="save-indicator" id="saveIndicator">✅ Сохранено!</div>

		<!-- Модальное окно выбора цветов -->
		<div id="colorPicker" class="modal">
			<div class="modal-content color-picker-content">
				<h2 class="modal-header">Выберите цвет проекта</h2>
				<input type="hidden" id="colorPickerProject" />
				<div class="color-options">
					<button
						class="color-option"
						data-color="#fc403a"
						style="background: #fc403a"
						onclick="selectProjectColor('#fc403a')"
					></button>
					<button
						class="color-option"
						data-color="#007bff"
						style="background: #007bff"
						onclick="selectProjectColor('#007bff')"
					></button>
					<button
						class="color-option"
						data-color="#28a745"
						style="background: #28a745"
						onclick="selectProjectColor('#28a745')"
					></button>
					<button
						class="color-option"
						data-color="#ffc107"
						style="background: #ffc107"
						onclick="selectProjectColor('#ffc107')"
					></button>
					<button
						class="color-option"
						data-color="#e83e8c"
						style="background: #e83e8c"
						onclick="selectProjectColor('#e83e8c')"
					></button>
					<button
						class="color-option"
						data-color="#6f42c1"
						style="background: #6f42c1"
						onclick="selectProjectColor('#6f42c1')"
					></button>
					<button
						class="color-option"
						data-color="#fd7e14"
						style="background: #fd7e14"
						onclick="selectProjectColor('#fd7e14')"
					></button>
					<button
						class="color-option"
						data-color="#20c997"
						style="background: #20c997"
						onclick="selectProjectColor('#20c997')"
					></button>
				</div>
				<div class="modal-buttons">
					<button class="btn btn-secondary" onclick="hideColorPicker()">
						Отмена
					</button>
				</div>
			</div>
		</div>

		<!-- Админ-панель -->
		<div class="admin-panel" id="adminPanel" style="display: none">
			<div class="admin-content">
				<div class="admin-header">
					<h2>👥 Управление пользователями (Доступ: greshnick250@gmail.com)</h2>
					<button class="close-admin" onclick="hideAdminPanel()">✕</button>
				</div>

				<div class="admin-stats">
					<div class="stat-card">
						<h3>Всего пользователей</h3>
						<span id="totalUsers">0</span>
					</div>
					<div class="stat-card">
						<h3>Активных проектов</h3>
						<span id="totalProjects">0</span>
					</div>
					<div class="stat-card">
						<h3>Всего задач</h3>
						<span id="totalTasks">0</span>
					</div>
				</div>

				<div class="users-management">
					<h3>📋 Список пользователей</h3>
					<div class="users-table">
						<div class="table-header">
							<span>Email</span>
							<span>Дата регистрации</span>
							<span>Статус</span>
							<span>Проекты</span>
							<span>Действия</span>
						</div>
						<div id="usersTableBody" class="table-body">
							<!-- Пользователи будут загружены динамически -->
						</div>
					</div>
				</div>

				<div class="system-management">
					<h3>⚙️ Системные функции</h3>
					<div class="system-actions">
						<button class="btn btn-info" onclick="exportData()">
							📥 Экспорт данных
						</button>
						<button class="btn btn-warning" onclick="clearCache()">
							🔄 Очистить кэш
						</button>
						<button class="btn btn-danger" onclick="confirmSystemReset()">
							⚠️ Сброс системы
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Индикатор статуса подключения -->
		<div class="connection-status" id="connectionStatus">
			🔄 Проверка подключения...
		</div>

		<script>
			// === СИСТЕМА АВТОРИЗАЦИИ ===

			// Глобальные переменные для авторизации
			let currentAuthMode = 'login' // 'login' или 'register'

			// Проверка авторизации при загрузке
			document.addEventListener('DOMContentLoaded', async function () {
				// Предварительная загрузка пользователей в фоне для ускорения входа
				preloadUsers()
				checkAuth()
			})

			// Переключение между вкладками
			function switchTab(mode) {
				currentAuthMode = mode
				const loginTab = document.getElementById('loginTab')
				const registerTab = document.getElementById('registerTab')
				const confirmPasswordField = document.getElementById(
					'confirmPasswordField'
				)
				const passwordRequirements = document.getElementById(
					'passwordRequirements'
				)
				const authBtn = document.getElementById('authBtn')

				if (mode === 'login') {
					loginTab.classList.add('active')
					registerTab.classList.remove('active')
					if (confirmPasswordField) {
						confirmPasswordField.style.display = 'none'
					}
					if (passwordRequirements) {
						passwordRequirements.style.display = 'none'
					}
					authBtn.querySelector('.btn-text').textContent = 'Войти'
				} else {
					loginTab.classList.remove('active')
					registerTab.classList.add('active')
					if (confirmPasswordField) {
						confirmPasswordField.style.display = 'block'
					}
					if (passwordRequirements) {
						passwordRequirements.style.display = 'block'
					}
					authBtn.querySelector('.btn-text').textContent = 'Зарегистрироваться'
				}

				clearErrors()
			}

			// Получение списка пользователей
			// Кэш для пользователей (чтобы избежать повторных запросов)
			let usersCache = null
			let usersCacheTime = 0
			const CACHE_DURATION = 30000 // 30 секунд
			const FIREBASE_TIMEOUT = 1000 // Уменьшаем таймаут до 1 секунды для еще большей скорости

			// Предварительная загрузка пользователей
			function preloadUsers() {
				// Запускаем загрузку пользователей в фоне без ожидания
				getUsers().catch(error => {
					console.log(
						'Предварительная загрузка пользователей не удалась:',
						error
					)
				})
			}

			async function getUsers() {
				// Проверяем кэш (если данные свежие)
				const now = Date.now()
				if (usersCache && now - usersCacheTime < CACHE_DURATION) {
					console.log('Использование кэшированных пользователей')
					return usersCache
				}

				try {
					// Если Firebase доступен, загружаем из облака с таймаутом
					if (isFirebaseAvailable && db) {
						console.log('Загрузка пользователей из Firebase...')

						// Создаем Promise с таймаутом
						const firebasePromise = db.collection('users').get()
						const timeoutPromise = new Promise((_, reject) =>
							setTimeout(
								() => reject(new Error('Firebase timeout')),
								FIREBASE_TIMEOUT
							)
						)

						const snapshot = await Promise.race([
							firebasePromise,
							timeoutPromise,
						])
						const users = {}
						snapshot.forEach(doc => {
							users[doc.id] = doc.data()
						})

						// Кэшируем результат
						usersCache = users
						usersCacheTime = now

						// Дублируем в localStorage как backup
						localStorage.setItem('registeredUsers', JSON.stringify(users))
						console.log(
							'Пользователи загружены из Firebase:',
							Object.keys(users)
						)
						return users
					}
				} catch (error) {
					console.error(
						'Ошибка загрузки пользователей из Firebase (переключение на localStorage):',
						error
					)
				}

				// Fallback к localStorage
				console.log('Загрузка пользователей из localStorage...')
				const users = localStorage.getItem('registeredUsers')
				const result = users ? JSON.parse(users) : {}

				// Кэшируем localStorage результат
				usersCache = result
				usersCacheTime = now

				return result
			}

			// Сохранение пользователя
			async function saveUser(email, password) {
				const userData = {
					email: email,
					password: password, // В реальном приложении пароль должен быть захешован!
					registeredAt: new Date().toISOString(),
				}

				try {
					// Если Firebase доступен, сохраняем в облако
					if (isFirebaseAvailable && db) {
						console.log('Сохранение пользователя в Firebase:', email)
						await db.collection('users').doc(email).set(userData)
						console.log('Пользователь сохранен в Firebase')
					}

					// Всегда дублируем в localStorage как backup
					const users =
						JSON.parse(localStorage.getItem('registeredUsers')) || {}
					users[email] = userData
					localStorage.setItem('registeredUsers', JSON.stringify(users))
					console.log('Пользователь сохранен в localStorage')

					// Сбрасываем кэш пользователей при добавлении нового
					usersCache = null
					usersCacheTime = 0
				} catch (error) {
					console.error('Ошибка сохранения пользователя:', error)
					// При ошибке Firebase все равно сохраняем в localStorage
					const users =
						JSON.parse(localStorage.getItem('registeredUsers')) || {}
					users[email] = userData
					localStorage.setItem('registeredUsers', JSON.stringify(users))

					// Сбрасываем кэш пользователей при добавлении нового
					usersCache = null
					usersCacheTime = 0
				}
			}

			// Проверка существования пользователя
			async function userExists(email) {
				const users = await getUsers()
				return users.hasOwnProperty(email)
			}

			// Проверка пароля пользователя
			async function validateUserPassword(email, password) {
				const users = await getUsers()
				return users[email] && users[email].password === password
			}

			// Проверка статуса авторизации
			function checkAuth() {
				const isLoggedIn = localStorage.getItem('isLoggedIn')
				const userEmail = localStorage.getItem('userEmail')

				if (isLoggedIn === 'true' && userEmail) {
					showMainApp()
				} else {
					showAuthScreen()
				}
			}

			// Показать экран авторизации
			function showAuthScreen() {
				document.getElementById('authScreen').style.display = 'flex'
				document.getElementById('mainApp').style.display = 'none'
			}

			// Показать основное приложение
			function showMainApp() {
				const authScreen = document.getElementById('authScreen')
				const mainApp = document.getElementById('mainApp')

				// Мгновенный переход без анимации для максимальной скорости
				authScreen.style.display = 'none'
				mainApp.style.display = 'block'

				// Проверить права админа
				checkAdminAccess()

				// Инициализация приложения начинается сразу
				initializeApp()
			}

			// === АДМИНИСТРАТИВНАЯ ПАНЕЛЬ ===

			// Универсальная проверка прав администратора
			function isAdmin() {
				const userEmail = localStorage.getItem('userEmail')
				return userEmail === 'greshnick250@gmail.com'
			}

			// Блокировка доступа для неадминистраторов
			function requireAdmin(functionName = 'эта функция') {
				if (!isAdmin()) {
					alert(`❌ Доступ запрещен!\n\n${functionName} доступна только администратору системы.`)
					return false
				}
				return true
			}

			// Проверка доступа к админ-панели
			function checkAdminAccess() {
				if (isAdmin()) {
					document.getElementById('adminBtn').style.display = 'block'
				}
			}

			// Показать админ-панель
			function showAdminPanel() {
				if (!requireAdmin('Панель управления')) return
				
				document.getElementById('adminPanel').style.display = 'flex'
				loadAdminData()
			}

			// Скрыть админ-панель
			function hideAdminPanel() {
				document.getElementById('adminPanel').style.display = 'none'
			}

			// Загрузка данных для админ-панели
			async function loadAdminData() {
				if (!requireAdmin('Загрузка данных администратора')) return
				
				try {
					// Загружаем пользователей
					const users = await getUsers()

					// Загружаем все проекты для подсчета статистики
					let allProjects = []
					let totalTasks = 0

					for (const email of Object.keys(users)) {
						try {
							const userProjects = await getProjects(email)
							allProjects = allProjects.concat(userProjects)

							// Подсчет задач
							userProjects.forEach(project => {
								if (project.tasks) {
									totalTasks += project.tasks.length
									// Подсчет подзадач
									project.tasks.forEach(task => {
										if (task.subtasks) {
											totalTasks += countSubtasks(task.subtasks)
										}
									})
								}
							})
						} catch (error) {
							console.log(`Ошибка загрузки проектов для ${email}:`, error)
						}
					}

					// Обновляем статистику
					document.getElementById('totalUsers').textContent =
						Object.keys(users).length
					document.getElementById('totalProjects').textContent =
						allProjects.length
					document.getElementById('totalTasks').textContent = totalTasks

					// Отображаем таблицу пользователей
					displayUsersTable(users, allProjects)
				} catch (error) {
					console.error('Ошибка загрузки данных админ-панели:', error)
				}
			}

			// Отображение таблицы пользователей
			function displayUsersTable(users, allProjects) {
				const tbody = document.getElementById('usersTableBody')
				tbody.innerHTML = ''

				for (const [email, userData] of Object.entries(users)) {
					// Пропускаем текущего админа
					if (email === localStorage.getItem('userEmail')) {
						continue
					}

					const userProjects = allProjects.filter(p => p.owner === email)
					const registrationDate = userData.registrationDate
						? new Date(userData.registrationDate).toLocaleDateString('ru-RU')
						: 'Неизвестно'

					// Проверяем статус пользователя
					const isBlocked = userData.blocked === true
					const statusClass = isBlocked ? 'status-blocked' : 'status-active'
					const statusText = isBlocked ? 'Заблокирован' : 'Активен'

					const row = document.createElement('div')
					row.className = 'user-row'
					row.innerHTML = `
						<div class="user-email">${email}</div>
						<div class="user-date">${registrationDate}</div>
						<div class="user-status ${statusClass}">${statusText}</div>
						<div class="user-projects">${userProjects.length}</div>
						<div class="user-actions">
							<button class="btn-small btn-view" onclick="viewUserDetails('${email}')" title="Просмотр">👁️</button>
							${
								isBlocked
									? `<button class="btn-small btn-unblock" onclick="unblockUser('${email}')" title="Разблокировать">🔓</button>`
									: `<button class="btn-small btn-block" onclick="blockUser('${email}')" title="Заблокировать">🔒</button>`
							}
							<button class="btn-small btn-delete" onclick="confirmDeleteUser('${email}')" title="Удалить">🗑️</button>
						</div>
					`
					tbody.appendChild(row)
				}
			}

			// Просмотр деталей пользователя
			function viewUserDetails(email) {
				if (!requireAdmin('Просмотр данных пользователей')) return
				
				loadUserDetails(email)
			}

			// Загрузка подробной информации о пользователе
			async function loadUserDetails(email) {
				try {
					const users = await getUsers()
					const userData = users[email]
					const userProjects = await getProjects(email)

					let projectsInfo = 'Проекты:\n'
					if (userProjects.length === 0) {
						projectsInfo += '- Нет проектов'
					} else {
						userProjects.forEach((project, index) => {
							const tasksCount = project.tasks ? project.tasks.length : 0
							projectsInfo += `${index + 1}. ${
								project.name
							} (${tasksCount} задач)\n`
						})
					}

					const registrationDate = userData.registrationDate
						? new Date(userData.registrationDate).toLocaleDateString('ru-RU')
						: 'Неизвестно'

					const status = userData.blocked ? 'Заблокирован' : 'Активен'

					alert(
						`📋 Информация о пользователе: ${email}\n\n` +
							`📅 Дата регистрации: ${registrationDate}\n` +
							`🔰 Статус: ${status}\n` +
							`📊 Количество проектов: ${userProjects.length}\n\n` +
							projectsInfo
					)
				} catch (error) {
					console.error('Ошибка загрузки деталей пользователя:', error)
					alert('Ошибка при загрузке информации о пользователе')
				}
			}

			// Блокировка пользователя
			async function blockUser(email) {
				if (!requireAdmin('Блокировка пользователей')) return
				
				if (
					confirm(
						`Заблокировать пользователя ${email}?\n\nПользователь не сможет войти в систему.`
					)
				) {
					try {
						await updateUserStatus(email, true)
						alert(`Пользователь ${email} заблокирован`)
						loadAdminData() // Обновляем таблицу
					} catch (error) {
						console.error('Ошибка блокировки пользователя:', error)
						alert('Ошибка при блокировке пользователя')
					}
				}
			}

			// Разблокировка пользователя
			async function unblockUser(email) {
				if (!requireAdmin('Разблокировка пользователей')) return
				
				if (confirm(`Разблокировать пользователя ${email}?`)) {
					try {
						await updateUserStatus(email, false)
						alert(`Пользователь ${email} разблокирован`)
						loadAdminData() // Обновляем таблицу
					} catch (error) {
						console.error('Ошибка разблокировки пользователя:', error)
						alert('Ошибка при разблокировке пользователя')
					}
				}
			}

			// Обновление статуса пользователя
			async function updateUserStatus(email, blocked) {
				try {
					// Обновляем в Firebase
					if (isFirebaseAvailable && db) {
						await db.collection('users').doc(email).update({
							blocked: blocked,
							lastStatusChange: new Date().toISOString(),
						})
					}

					// Обновляем в localStorage
					const registeredUsers = JSON.parse(
						localStorage.getItem('registeredUsers') || '{}'
					)
					if (registeredUsers[email]) {
						registeredUsers[email].blocked = blocked
						registeredUsers[email].lastStatusChange = new Date().toISOString()
						localStorage.setItem(
							'registeredUsers',
							JSON.stringify(registeredUsers)
						)
					}

					// Очищаем кэш пользователей
					usersCache = null
				} catch (error) {
					console.error('Ошибка обновления статуса пользователя:', error)
					throw error
				}
			}

			// Подтверждение удаления пользователя
			async function confirmDeleteUser(email) {
				if (!requireAdmin('Удаление пользователей')) return
				
				try {
					// Получаем информацию о пользователе перед удалением
					const userProjects = await getProjects(email)
					const projectsCount = userProjects.length
					let tasksCount = 0

					userProjects.forEach(project => {
						if (project.tasks) {
							tasksCount += project.tasks.length
							project.tasks.forEach(task => {
								if (task.subtasks) {
									tasksCount += countSubtasks(task.subtasks)
								}
							})
						}
					})

					const confirmMessage =
						`⚠️ УДАЛЕНИЕ ПОЛЬЗОВАТЕЛЯ ⚠️\n\n` +
						`Пользователь: ${email}\n` +
						`Проектов: ${projectsCount}\n` +
						`Задач: ${tasksCount}\n\n` +
						`Это действие необратимо!\n` +
						`Все данные пользователя будут удалены навсегда.\n\n` +
						`Вы уверены, что хотите продолжить?`

					if (confirm(confirmMessage)) {
						if (
							confirm(
								`Последнее предупреждение!\n\nУдалить пользователя ${email} со всеми данными?`
							)
						) {
							await deleteUser(email)
						}
					}
				} catch (error) {
					console.error('Ошибка при подготовке удаления:', error)
					if (
						confirm(
							`Не удалось загрузить данные пользователя ${email}.\n\nУдалить пользователя?`
						)
					) {
						await deleteUser(email)
					}
				}
			}

			// Удаление пользователя
			async function deleteUser(email) {
				try {
					let deletedItems = { projects: 0, hypotheses: 0 }

					// Удаляем пользователя из Firebase
					if (isFirebaseAvailable && db) {
						// Удаляем пользователя
						await db.collection('users').doc(email).delete()

						// Удаляем все проекты пользователя
						const projectsSnapshot = await db
							.collection('projects')
							.where('owner', '==', email)
							.get()
						deletedItems.projects = projectsSnapshot.size
						const batch = db.batch()
						projectsSnapshot.forEach(doc => {
							batch.delete(doc.ref)
						})
						await batch.commit()

						// Удаляем все гипотезы пользователя
						const hypothesesSnapshot = await db
							.collection('hypotheses')
							.where('owner', '==', email)
							.get()
						deletedItems.hypotheses = hypothesesSnapshot.size
						const hypothesesBatch = db.batch()
						hypothesesSnapshot.forEach(doc => {
							hypothesesBatch.delete(doc.ref)
						})
						await hypothesesBatch.commit()
					}

					// Удаляем из localStorage
					const registeredUsers = JSON.parse(
						localStorage.getItem('registeredUsers') || '{}'
					)
					delete registeredUsers[email]
					localStorage.setItem(
						'registeredUsers',
						JSON.stringify(registeredUsers)
					)

					// Удаляем пользовательские данные из localStorage
					localStorage.removeItem(`projects_${email}`)
					localStorage.removeItem(`hypotheses_${email}`)

					// Очищаем кэш
					usersCache = null

					const successMessage =
						`✅ Пользователь успешно удален!\n\n` +
						`Email: ${email}\n` +
						`Удалено проектов: ${deletedItems.projects}\n` +
						`Удалено гипотез: ${deletedItems.hypotheses}`

					alert(successMessage)
					loadAdminData() // Обновляем данные
				} catch (error) {
					console.error('Ошибка удаления пользователя:', error)
					alert(
						`❌ Ошибка при удалении пользователя ${email}:\n\n${error.message}`
					)
				}
			}

			// Экспорт данных
			async function exportData() {
				if (!requireAdmin('Экспорт данных')) return
				
				try {
					const users = await getUsers()
					const data = {
						users: users,
						exportDate: new Date().toISOString(),
						version: '1.0',
					}

					const blob = new Blob([JSON.stringify(data, null, 2)], {
						type: 'application/json',
					})
					const url = URL.createObjectURL(blob)
					const a = document.createElement('a')
					a.href = url
					a.download = `users_export_${
						new Date().toISOString().split('T')[0]
					}.json`
					a.click()
					URL.revokeObjectURL(url)
				} catch (error) {
					console.error('Ошибка экспорта данных:', error)
					alert('Ошибка при экспорте данных')
				}
			}

			// Очистка кэша
			function clearCache() {
				if (!requireAdmin('Очистка кэша')) return
				
				usersCache = null
				projectsCache = {}
				hypothesesCache = {}
				alert('Кэш очищен')
			}

			// Подтверждение сброса системы
			function confirmSystemReset() {
				if (!requireAdmin('Сброс системы')) return
				
				if (
					confirm('ВНИМАНИЕ! Это удалит ВСЕ данные системы.\n\nВы уверены?')
				) {
					if (
						confirm(
							'Последнее предупреждение! Все пользователи и проекты будут удалены навсегда.\n\nПродолжить?'
						)
					) {
						resetSystem()
					}
				}
			}

			// Сброс системы
			async function resetSystem() {
				try {
					// Очистка Firebase
					if (isFirebaseAvailable && db) {
						const collections = ['users', 'projects', 'hypotheses']
						for (const collectionName of collections) {
							const snapshot = await db.collection(collectionName).get()
							const batch = db.batch()
							snapshot.forEach(doc => {
								batch.delete(doc.ref)
							})
							await batch.commit()
						}
					}

					// Очистка localStorage
					const keysToRemove = []
					for (let key in localStorage) {
						if (
							key.startsWith('registeredUsers') ||
							key.startsWith('projects_') ||
							key.startsWith('hypotheses_') ||
							key === 'isLoggedIn' ||
							key === 'userEmail'
						) {
							keysToRemove.push(key)
						}
					}
					keysToRemove.forEach(key => localStorage.removeItem(key))

					alert('Система полностью сброшена')
					window.location.reload()
				} catch (error) {
					console.error('Ошибка сброса системы:', error)
					alert('Ошибка при сбросе системы')
				}
			}

			// Обработка формы авторизации
			document.addEventListener('DOMContentLoaded', function () {
				const authForm = document.getElementById('authForm')

				authForm.addEventListener('submit', async function (e) {
					e.preventDefault()
					if (currentAuthMode === 'login') {
						await handleLogin()
					} else {
						await handleRegister()
					}
				})
			})

			// Обработка входа
			async function handleLogin() {
				const email = document.getElementById('email').value.trim()
				const password = document.getElementById('password').value
				const authBtn = document.getElementById('authBtn')
				const authCard = document.querySelector('.auth-card')

				// Очистка предыдущих ошибок
				clearErrors()

				// Валидация
				if (!validateLoginForm(email, password)) {
					showErrorAnimation(authCard)
					return
				}

				// Показать загрузку
				showLoading(authBtn, true)

				try {
					// Одноразовая загрузка пользователей для обеих проверок
					const users = await getUsers()

					// Проверка существования пользователя
					if (!users.hasOwnProperty(email)) {
						throw new Error(
							'Проверьте правильность заполнения почты - пользователь не найден. Зарегистрируйтесь сначала.'
						)
					}

					// Проверка пароля
					if (!users[email] || users[email].password !== password) {
						throw new Error('Проверьте пароль - неверный пароль')
					}

					// Проверка блокировки пользователя
					if (users[email].blocked === true) {
						throw new Error(
							'Ваш аккаунт заблокирован администратором. Обратитесь в службу поддержки.'
						)
					}

					// Сохранение данных авторизации
					localStorage.setItem('isLoggedIn', 'true')
					localStorage.setItem('userEmail', email)

					// Показать успех и сразу переходить к приложению
					showSuccess()
					showMainApp()
				} catch (error) {
					showAuthError(error.message)
					showErrorAnimation(authCard)
				} finally {
					showLoading(authBtn, false)
				}
			}

			// Обработка регистрации
			async function handleRegister() {
				const email = document.getElementById('email').value.trim()
				const password = document.getElementById('password').value
				const confirmPassword = document.getElementById('confirmPassword').value
				const authBtn = document.getElementById('authBtn')
				const authCard = document.querySelector('.auth-card')

				// Очистка предыдущих ошибок
				clearErrors()

				// Валидация
				if (!validateRegisterForm(email, password, confirmPassword)) {
					showErrorAnimation(authCard)
					return
				}

				// Показать загрузку
				showLoading(authBtn, true)

				try {
					// Проверка существования пользователя
					const userExistsResult = await userExists(email)
					if (userExistsResult) {
						throw new Error('Пользователь с таким email уже существует')
					}

					// Сохранение нового пользователя
					await saveUser(email, password)

					// Обновление списка пользователей
					// await displayRegisteredUsers() // Убрали, больше не нужно

					// Показать успех и мгновенно переходить на вход
					showSuccess()
					authBtn.querySelector('.btn-text').textContent = 'Зарегистрирован!'

					// Мгновенный автоматический переход на вход
					setTimeout(() => {
						switchTab('login')
						document.getElementById('email').value = email
						document.getElementById('password').value = ''
						showNotification('Регистрация успешна! Теперь войдите в систему')
					}, 100)
				} catch (error) {
					showAuthError(error.message)
					showErrorAnimation(authCard)
				} finally {
					showLoading(authBtn, false)
				}
			}

			// Валидация формы входа
			function validateLoginForm(email, password) {
				let isValid = true

				// Улучшенная проверка email (поддерживает цифры и специальные символы)
				const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
				if (!email) {
					showFieldError('emailError', 'Email обязателен')
					isValid = false
				} else if (!emailRegex.test(email)) {
					showFieldError(
						'emailError',
						'Проверьте правильность заполнения почты (например: user123@domain.com)'
					)
					isValid = false
				}

				// Строгая проверка пароля
				if (!password) {
					showFieldError('passwordError', 'Пароль обязателен')
					isValid = false
				} else {
					const passwordErrors = validatePassword(password)
					if (passwordErrors.length > 0) {
						showFieldError(
							'passwordError',
							'Проверьте пароль. ' + passwordErrors.join('. ')
						)
						isValid = false
					}
				}

				return isValid
			}

			// Валидация формы регистрации
			function validateRegisterForm(email, password, confirmPassword) {
				let isValid = true

				// Улучшенная проверка email (поддерживает цифры и специальные символы)
				const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/
				if (!email) {
					showFieldError('emailError', 'Email обязателен')
					isValid = false
				} else if (!emailRegex.test(email)) {
					showFieldError(
						'emailError',
						'Проверьте правильность заполнения почты (например: user123@domain.com)'
					)
					isValid = false
				}

				// Строгая проверка пароля
				if (!password) {
					showFieldError('passwordError', 'Пароль обязателен')
					isValid = false
				} else {
					const passwordErrors = validatePassword(password)
					if (passwordErrors.length > 0) {
						showFieldError(
							'passwordError',
							'Проверьте пароль. ' + passwordErrors.join('. ')
						)
						isValid = false
					}
				}

				// Проверка подтверждения пароля
				if (!confirmPassword) {
					showFieldError('confirmPasswordError', 'Подтвердите пароль')
					isValid = false
				} else if (password !== confirmPassword) {
					showFieldError('confirmPasswordError', 'Пароли не совпадают')
					isValid = false
				}

				return isValid
			}

			// Функция строгой валидации пароля
			function validatePassword(password) {
				const errors = []

				// Минимум 8 символов
				if (password.length < 8) {
					errors.push('Минимум 8 символов')
				}

				// Только латинские буквы, цифры и специальные символы
				const latinOnlyRegex = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{}|;:,.<>?]+$/
				if (!latinOnlyRegex.test(password)) {
					errors.push('Только латинские буквы, цифры и символы')
				}

				// Обязательно одна заглавная буква
				const hasUpperCase = /[A-Z]/.test(password)
				if (!hasUpperCase) {
					errors.push('Минимум одна заглавная буква')
				}

				// Обязательно один специальный символ
				const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)
				if (!hasSpecialChar) {
					errors.push('Минимум один специальный символ (!@#$%^&* и т.д.)')
				}

				// Обязательно одна цифра
				const hasNumber = /[0-9]/.test(password)
				if (!hasNumber) {
					errors.push('Минимум одна цифра')
				}

				return errors
			}

			// Показать ошибку поля
			function showFieldError(errorId, message) {
				const errorElement = document.getElementById(errorId)
				errorElement.textContent = message
				errorElement.classList.add('show')
			}

			// Показать общую ошибку авторизации
			function showAuthError(message) {
				const errorElement = document.getElementById('authError')
				errorElement.textContent = message
				errorElement.classList.add('show')
			}

			// Очистить ошибки
			function clearErrors() {
				const errors = document.querySelectorAll('.input-error, .auth-error')
				errors.forEach(error => {
					error.classList.remove('show')
					error.textContent = ''
				})
			}

			// Показать анимацию ошибки
			function showErrorAnimation(element) {
				element.classList.add('error')
				setTimeout(() => {
					element.classList.remove('error')
				}, 600)
			}

			// Показать/скрыть загрузку
			function showLoading(button, show) {
				if (show) {
					button.classList.add('loading')
					button.disabled = true
				} else {
					button.classList.remove('loading')
					button.disabled = false
				}
			}

			// Показать успех
			function showSuccess() {
				const authBtn = document.getElementById('authBtn')
				authBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)'
				if (currentAuthMode === 'login') {
					authBtn.querySelector('.btn-text').textContent = 'Успешно!'
				}
			}

			// Выход из системы
			async function logout() {
				localStorage.removeItem('isLoggedIn')
				localStorage.removeItem('userEmail')

				// Скрыть основное приложение и показать авторизацию
				document.getElementById('mainApp').style.display = 'none'
				document.getElementById('authScreen').style.display = 'flex'
				document.getElementById('authScreen').classList.remove('fade-out')

				// Переключиться на вкладку входа
				switchTab('login')

				// Очистить форму
				document.getElementById('authForm').reset()
				clearErrors()

				// Сбросить кнопку
				const authBtn = document.getElementById('authBtn')
				authBtn.style.background = ''
				authBtn.querySelector('.btn-text').textContent = 'Войти'
			}

			// Инициализация основного приложения
			async function initializeApp() {
				try {
					console.log('Инициализация приложения...')
					showConnectionStatus()
					showLoadingIndicator('Загрузка данных...')
					await loadProjects()
					await loadHypotheses() // Загружаем гипотезы при инициализации
					// Сразу скрываем индикатор после загрузки без задержки
					hideLoadingIndicator()
					updateConnectionStatus()
					console.log('Приложение инициализировано успешно')
				} catch (error) {
					console.error('Ошибка при инициализации приложения:', error)
					hideLoadingIndicator()
					showNotification('Ошибка загрузки приложения')
					updateConnectionStatus()
					// Показываем интерфейс даже при ошибке
					renderProjectsList()
				}
			}

			// === ОСНОВНОЙ КОД ПРИЛОЖЕНИЯ ===

			// Вспомогательная функция для безопасного отображения HTML
			function escapeHTML(text) {
				const div = document.createElement('div')
				div.textContent = text
				return div.innerHTML
			}

			// Глобальная обработка ошибок
			window.onerror = function (message, source, lineno, colno, error) {
				console.error('Ошибка:', message, 'в', source, 'строка', lineno)
				return true
			}

			// Глобальные переменные
			let projects = {}
			let currentProject = null
			let tasks = []
			let notes = []

			// Загрузка данных при старте
			document.addEventListener('DOMContentLoaded', async function () {
				// Проверяем авторизацию вместо сразу загрузки проектов
				// checkAuth() уже обрабатывается в системе авторизации
			})

			// Универсальная функция получения проектов пользователя
			async function getProjects(email) {
				try {
					// Если Firebase доступен, загружаем из Firestore
					if (isFirebaseAvailable && db) {
						const projectsSnapshot = await db
							.collection('projects')
							.where('owner', '==', email)
							.get()

						const userProjects = []
						projectsSnapshot.forEach(doc => {
							userProjects.push({ id: doc.id, ...doc.data() })
						})

						return userProjects
					} else {
						// Если Firebase недоступен, используем localStorage
						const userProjects = localStorage.getItem(`projects_${email}`)
						if (userProjects) {
							const projectsData = JSON.parse(userProjects)
							return Object.values(projectsData)
						}
						return []
					}
				} catch (error) {
					console.error(`Ошибка загрузки проектов для ${email}:`, error)
					return []
				}
			}

			// Загрузка всех проектов из Firestore
			async function loadProjects() {
				try {
					console.log('Загрузка проектов для пользователя...')

					// Получаем email текущего пользователя
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						projects = {}
						renderProjectsList()
						return
					}

					// Если Firebase недоступен, используем localStorage с разделением по пользователям
					if (!isFirebaseAvailable || !db) {
						console.log('Firebase недоступен, используем localStorage')
						const allUserProjects = localStorage.getItem('allProjects')
						const userProjects = localStorage.getItem(`projects_${userEmail}`)

						if (userProjects) {
							projects = JSON.parse(userProjects)
							console.log(
								`Проекты пользователя ${userEmail} загружены из localStorage:`,
								projects
							)
						} else if (allUserProjects) {
							// Миграция старых данных
							const oldProjects = JSON.parse(allUserProjects)
							projects = oldProjects
							localStorage.setItem(
								`projects_${userEmail}`,
								JSON.stringify(projects)
							)
							console.log(
								'Мигрированы старые проекты для пользователя:',
								projects
							)
						} else {
							console.log('Нет сохраненных проектов для пользователя')
							projects = {}
						}
						renderProjectsList()
						return
					}

					console.log(
						`Загрузка проектов из Firestore для пользователя: ${userEmail}`
					)
					const snapshot = await db
						.collection('projects')
						.where('owner', '==', userEmail)
						.get()
					projects = {}

					snapshot.forEach(doc => {
						projects[doc.id] = {
							id: doc.id,
							...doc.data(),
						}
					})

					console.log(
						`Проекты пользователя ${userEmail} загружены из Firestore:`,
						projects
					)

					// Сохраняем в localStorage как backup
					localStorage.setItem(
						`projects_${userEmail}`,
						JSON.stringify(projects)
					)
					renderProjectsList()
				} catch (error) {
					console.error('Ошибка при загрузке проектов:', error)
					// Fallback к localStorage при ошибке
					try {
						console.log('Fallback к localStorage при ошибке')
						const userEmail = localStorage.getItem('userEmail')
						const userProjects = localStorage.getItem(`projects_${userEmail}`)
						if (userProjects) {
							projects = JSON.parse(userProjects)
							console.log(
								`Загружены проекты пользователя ${userEmail} из localStorage как fallback:`,
								projects
							)
						} else {
							projects = {}
							console.log(
								'localStorage пуст для пользователя, инициализируем пустой объект'
							)
						}
					} catch (localError) {
						console.error('Ошибка загрузки из localStorage:', localError)
						projects = {}
					}
					renderProjectsList()
				}
			}

			// Сохранение проекта в Firestore
			async function saveProject(projectId, projectData) {
				try {
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						return false
					}

					// Добавляем владельца к данным проекта
					const projectWithOwner = {
						...projectData,
						owner: userEmail,
						updatedAt: new Date().toISOString(),
					}

					if (!isFirebaseAvailable || !db) {
						console.log('Firebase недоступен, сохраняем в localStorage')
						const userProjects =
							JSON.parse(localStorage.getItem(`projects_${userEmail}`)) || {}
						userProjects[projectId] = projectWithOwner
						localStorage.setItem(
							`projects_${userEmail}`,
							JSON.stringify(userProjects)
						)
						return true
					}

					await db.collection('projects').doc(projectId).set(projectWithOwner)
					console.log(
						'Проект сохранен в Firestore для пользователя:',
						projectId,
						userEmail
					)

					// Дублируем в localStorage как backup
					const backupProjects =
						JSON.parse(localStorage.getItem(`projects_${userEmail}`)) || {}
					backupProjects[projectId] = projectWithOwner
					localStorage.setItem(
						`projects_${userEmail}`,
						JSON.stringify(backupProjects)
					)

					return true
				} catch (error) {
					console.error('Ошибка при сохранении проекта:', error)
					return false
				}
			}

			// Удаление проекта из Firestore
			async function deleteProjectFromFirestore(projectId) {
				try {
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						return false
					}

					// Если Firebase недоступен, удаляем из localStorage
					if (!isFirebaseAvailable || !db) {
						console.log('Firebase недоступен, удаляем из localStorage')
						delete projects[projectId]
						const userProjects =
							JSON.parse(localStorage.getItem(`projects_${userEmail}`)) || {}
						delete userProjects[projectId]
						localStorage.setItem(
							`projects_${userEmail}`,
							JSON.stringify(userProjects)
						)
						return true
					}

					await db.collection('projects').doc(projectId).delete()
					console.log('Проект удален из Firestore:', projectId)

					// Также удаляем из localStorage
					const userProjects =
						JSON.parse(localStorage.getItem(`projects_${userEmail}`)) || {}
					delete userProjects[projectId]
					localStorage.setItem(
						`projects_${userEmail}`,
						JSON.stringify(userProjects)
					)
					return true
				} catch (error) {
					console.error('Ошибка при удалении проекта из Firestore:', error)
					// Fallback к localStorage
					try {
						delete projects[projectId]
						localStorage.setItem('allProjects', JSON.stringify(projects))
						console.log('Проект удален из localStorage как fallback')
						return true
					} catch (localError) {
						console.error('Ошибка удаления из localStorage:', localError)
						return false
					}
				}
			}

			// Отображение списка проектов
			function renderProjectsList() {
				console.log(
					'Начало рендеринга списка проектов. Всего проектов:',
					Object.keys(projects).length
				)
				const grid = document.getElementById('projectsGrid')

				if (!grid) {
					console.error('Элемент projectsGrid не найден!')
					return
				}

				// Очищаем грид
				grid.innerHTML = ''

				// Добавляем карточки проектов
				Object.keys(projects).forEach(projectId => {
					const project = projects[projectId]
					console.log('Создание карточки для проекта:', project.name)
					const card = createProjectCard(project)
					grid.appendChild(card)
				})

				// Создаем кнопку добавления заново
				const newAddButton = document.createElement('div')
				newAddButton.className = 'project-card add-project-card'
				newAddButton.onclick = showCreateProjectModal
				newAddButton.innerHTML = `
					<div class="project-icon">➕</div>
					<div class="project-name">Создать новый проект</div>
				`
				grid.appendChild(newAddButton)

				console.log(
					'Список проектов обновлен. Всего проектов:',
					Object.keys(projects).length,
					'Карточек в DOM:',
					grid.children.length
				)
			}

			// Создание карточки проекта
			function createProjectCard(project) {
				const card = document.createElement('div')
				card.className = 'project-card'

				// Применяем цвет проекта
				const projectColor = project.color || '#fc403a'
				card.style.borderLeft = `5px solid ${projectColor}`

				// Подсчет только главных задач (без подзадач)
				let totalTasks = 0
				let completedTasks = 0

				if (project.tasks) {
					totalTasks = project.tasks.length // Только главные задачи
					completedTasks = project.tasks.filter(task => task.completed).length // Только выполненные главные задачи
				}

				card.innerHTML = `
                <div class="project-delete" data-project-id="${project.id}">
						&#x1F5D1;
					</div>
					<div class="project-color-btn" data-project-id="${
						project.id
					}" title="Изменить цвет">
						🎨
					</div>
					<div class="project-content" data-project-id="${project.id}">
						<div class="project-icon">📁</div>
						<div class="project-name">${escapeHTML(project.name)}</div>
						<div class="project-stats">
							Задач: ${totalTasks} | Выполнено: ${completedTasks}
						</div>
					</div>
            `

				// Добавляем обработчики событий
				const deleteBtn = card.querySelector('.project-delete')
				const colorBtn = card.querySelector('.project-color-btn')
				const content = card.querySelector('.project-content')

				deleteBtn.addEventListener('click', function (e) {
					e.stopPropagation()
					e.preventDefault()
					const projectId = project.id // Напрямую используем id из объекта проекта
					console.log('Попытка удалить проект:', projectId)
					confirmDeleteProject(projectId, project.name)
				})

				colorBtn.addEventListener('click', function (e) {
					e.stopPropagation()
					e.preventDefault()
					const projectId = project.id
					showColorPicker(projectId)
				})

				content.addEventListener('click', function (e) {
					e.stopPropagation()
					const projectId = project.id // Напрямую используем id из объекта проекта
					console.log('Открытие проекта:', projectId)
					openProject(projectId)
				})

				return card
			}

			// Показать модальное окно создания проекта
			function showCreateProjectModal() {
				document.getElementById('createProjectModal').style.display = 'block'
				document.getElementById('newProjectName').value = ''
				document.getElementById('newProjectName').focus()
			}

			// Скрыть модальное окно
			function hideCreateProjectModal() {
				document.getElementById('createProjectModal').style.display = 'none'
			}

			// Создать новый проект
			async function createProject() {
				const projectName = document
					.getElementById('newProjectName')
					.value.trim()

				if (!projectName) {
					showNotification('Введите название проекта!')
					return
				}

				// Сразу создаем проект локально
				const projectId = 'project_' + Date.now()
				const newProject = {
					id: projectId,
					name: projectName,
					tasks: [],
					notes: [],
					createdAt: new Date().toISOString(),
				}

				// Добавляем проект в локальный объект сразу
				projects[projectId] = newProject

				// Закрываем модальное окно и обновляем список
				hideCreateProjectModal()
				renderProjectsList()
				showNotification('Проект создан!')

				// Сохраняем в фоновом режиме
				saveProject(projectId, newProject)
					.then(success => {
						if (success) {
							console.log('Проект сохранен в облаке:', projectId)
						} else {
							console.log('Проект сохранен локально:', projectId)
						}
					})
					.catch(error => {
						console.error('Ошибка сохранения в облаке:', error)
						// Но проект уже создан локально, поэтому не показываем ошибку пользователю
					})
			}

			// Открыть проект
			function openProject(projectId) {
				currentProject = projectId
				const project = projects[projectId]

				if (!project) {
					console.error('Проект не найден:', projectId)
					return
				}

				// Загружаем данные проекта
				tasks = project.tasks || []
				notes = project.notes || []

				// Обновляем интерфейс
				document.getElementById('projectTitle').textContent = project.name

				// Переключаем страницы
				document.getElementById('projectsListPage').style.display = 'none'
				document.getElementById('projectPage').style.display = 'block'

				// Обновляем отображение
				renderTasks()
				renderNotes()
				updateStats()

				console.log('Открыт проект:', projectId, project.name)
			}

			// Вернуться к списку проектов
			function showProjectsList() {
				// Переключаемся без задержки
				currentProject = null
				document.getElementById('projectPage').style.display = 'none'
				document.getElementById('projectsListPage').style.display = 'block'
				renderProjectsList()
			}

			// Сохранить текущий проект
			function saveCurrentProject() {
				if (currentProject && projects[currentProject]) {
					// Сначала обновляем локальные данные
					projects[currentProject].tasks = tasks
					projects[currentProject].notes = notes

					// Сохраняем в Firestore/localStorage в фоновом режиме
					saveProject(currentProject, projects[currentProject])
						.then(success => {
							if (success) {
								console.log('Сохранен текущий проект:', currentProject)
							} else {
								console.error('Ошибка сохранения проекта:', currentProject)
							}
						})
						.catch(error => {
							console.error('Ошибка при сохранении:', error)
						})

					// Возвращаем успешный результат сразу
					return true
				}
				return false
			}

			// Подтверждение удаления проекта с главной страницы
			async function confirmDeleteProject(projectId, projectName) {
				console.log('Удаление проекта:', projectId, projectName)

				const message = `Вы действительно хотите удалить проект "${projectName}"?\n\nВсе задачи и заметки будут удалены безвозвратно!`

				if (confirm(message)) {
					showLoadingIndicator('Удаление проекта...')
					console.log('Пользователь подтвердил удаление проекта:', projectId)

					const success = await deleteProjectFromFirestore(projectId)
					if (success) {
						delete projects[projectId]
						renderProjectsList()
						showNotification(`Проект "${projectName}" удален!`)
					} else {
						showNotification('Ошибка удаления проекта!')
					}

					hideLoadingIndicator()
				} else {
					console.log('Пользователь отменил удаление проекта:', projectId)
				}
			}

			// Удалить проект (из страницы проекта)
			async function deleteProject() {
				if (!currentProject) {
					console.error('Нет текущего проекта для удаления')
					return
				}

				const project = projects[currentProject]
				if (!project) {
					console.error('Проект не найден:', currentProject)
					return
				}

				const message = `Вы уверены, что хотите удалить проект "${project.name}"?\n\nЭто действие нельзя отменить!`

				if (confirm(message)) {
					showLoadingIndicator('Удаление проекта...')
					console.log('Удаление проекта из страницы проекта:', currentProject)

					const success = await deleteProjectFromFirestore(currentProject)
					if (success) {
						delete projects[currentProject]
						showProjectsList()
						showNotification(`Проект "${project.name}" удален!`)
					} else {
						showNotification('Ошибка удаления проекта!')
					}

					hideLoadingIndicator()
				}
			}

			// Функция добавления задачи
			function addTask() {
				const input = document.getElementById('taskInput')
				const taskText = input.value.trim()

				if (taskText && currentProject) {
					const newTask = {
						id: Date.now(),
						text: taskText,
						completed: false,
						subtasks: [],
						subtasksExpanded: false,
						createdAt: new Date().toISOString(),
					}

					tasks.unshift(newTask)
					input.value = ''
					input.focus()
					renderTasks()
					updateStats()
					// Моментально сохраняем в фоне
					saveCurrentProject()
					showNotification('Задача добавлена!')
				}
			}

			// Добавить подзадачу (простую, без вложенности)
			function addSubtask(taskId) {
				const input = document.getElementById(`subtaskInput_${taskId}`)
				const subtaskText = input.value.trim()

				if (!subtaskText) return

				const task = tasks.find(t => t.id === taskId)
				if (task) {
					if (!task.subtasks) {
						task.subtasks = []
					}

					const newSubtask = {
						id: Date.now() + Math.random(),
						text: subtaskText,
						completed: false,
						subtasks: [],
						subtasksExpanded: false,
						createdAt: new Date().toISOString(),
					}

					task.subtasks.push(newSubtask)
					// Автоматически раскрываем список при добавлении новой подзадачи
					task.subtasksExpanded = true

					hideSubtaskForm(taskId)
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Подзадача добавлена!')
				}
			}

			// Показать форму добавления подзадачи
			function showSubtaskForm(taskId) {
				const form = document.getElementById(`subtaskForm_${taskId}`)
				if (form) {
					form.style.display = 'flex'
					const input = document.getElementById(`subtaskInput_${taskId}`)
					if (input) {
						input.focus()
					}
				}
			}

			// Скрыть форму добавления подзадачи
			function hideSubtaskForm(taskId) {
				const form = document.getElementById(`subtaskForm_${taskId}`)
				if (form) {
					form.style.display = 'none'
					const input = document.getElementById(`subtaskInput_${taskId}`)
					if (input) {
						input.value = ''
					}
				}
			}

			// Переключить видимость подзадач
			function toggleSubtasks(taskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task) {
					task.subtasksExpanded = !task.subtasksExpanded
					renderTasks()
					saveCurrentProject()
				}
			}

			// Переключить статус подзадачи
			function toggleSubtask(taskId, subtaskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task && task.subtasks) {
					const subtask = task.subtasks.find(st => st.id === subtaskId)
					if (subtask) {
						subtask.completed = !subtask.completed
						renderTasks()
						updateStats()
						saveCurrentProject()
						showSaveIndicator()
					}
				}
			}

			// Удалить подзадачу
			function deleteSubtask(taskId, subtaskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task && task.subtasks) {
					task.subtasks = task.subtasks.filter(st => st.id !== subtaskId)
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Подзадача удалена!')
				}
			}

			// Функция для подсчета количества подзадач (включая вложенные)
			function countSubtasks(subtasks) {
				if (!subtasks || subtasks.length === 0) return 0

				let count = subtasks.length
				subtasks.forEach(subtask => {
					if (subtask.subtasks) {
						count += countSubtasks(subtask.subtasks)
					}
				})
				return count
			}

			// Рекурсивный поиск подзадачи по ID
			function findSubtaskRecursive(subtasks, subtaskId) {
				if (!subtasks) return null

				for (let subtask of subtasks) {
					if (subtask.id === subtaskId) {
						return subtask
					}

					if (subtask.subtasks) {
						const found = findSubtaskRecursive(subtask.subtasks, subtaskId)
						if (found) return found
					}
				}
				return null
			}

			// Рекурсивное обновление подзадачи
			function updateSubtaskRecursive(subtasks, subtaskId, updateFn) {
				if (!subtasks) return false

				for (let subtask of subtasks) {
					if (subtask.id === subtaskId) {
						updateFn(subtask)
						return true
					}

					if (
						subtask.subtasks &&
						updateSubtaskRecursive(subtask.subtasks, subtaskId, updateFn)
					) {
						return true
					}
				}
				return false
			}

			// Рекурсивное удаление подзадачи
			function removeSubtaskRecursive(subtasks, subtaskId) {
				if (!subtasks) return false

				for (let i = 0; i < subtasks.length; i++) {
					if (subtasks[i].id === subtaskId) {
						subtasks.splice(i, 1)
						return true
					}

					if (
						subtasks[i].subtasks &&
						removeSubtaskRecursive(subtasks[i].subtasks, subtaskId)
					) {
						return true
					}
				}
				return false
			}

			// Показать форму добавления подзадачи (рекурсивная)
			function showSubtaskFormRecursive(taskId, parentSubtaskId) {
				hideAllSubtaskForms()
				const formId = `subtaskForm_${taskId}_${parentSubtaskId}`
				const form = document.getElementById(formId)
				if (form) {
					form.style.display = 'flex'
					const input = document.getElementById(
						`subtaskInput_${taskId}_${parentSubtaskId}`
					)
					if (input) input.focus()
				}
			}

			// Скрыть форму добавления подзадачи (рекурсивная)
			function hideSubtaskFormRecursive(taskId, parentSubtaskId) {
				const formId = `subtaskForm_${taskId}_${parentSubtaskId}`
				const form = document.getElementById(formId)
				if (form) {
					form.style.display = 'none'
					const input = document.getElementById(
						`subtaskInput_${taskId}_${parentSubtaskId}`
					)
					if (input) input.value = ''
				}
			}

			// Добавить подзадачу (рекурсивная)
			function addSubtaskRecursive(taskId, parentSubtaskId) {
				const inputId = `subtaskInput_${taskId}_${parentSubtaskId}`
				const input = document.getElementById(inputId)
				const text = input.value.trim()

				if (text) {
					const task = tasks.find(t => t.id === taskId)
					if (task) {
						// Найти родительскую подзадачу
						const parentSubtask = findSubtaskRecursive(
							task.subtasks,
							parentSubtaskId
						)
						if (parentSubtask) {
							if (!parentSubtask.subtasks) {
								parentSubtask.subtasks = []
							}

							const newSubtask = {
								id: Date.now() + Math.random(),
								text: text,
								completed: false,
								subtasks: [],
								subtasksExpanded: false,
							}

							parentSubtask.subtasks.push(newSubtask)
							input.value = ''
							hideSubtaskFormRecursive(taskId, parentSubtaskId)
							renderTasks()
							updateStats()
							saveCurrentProject()
							showSaveIndicator()
							showNotification('Подзадача добавлена!')
						}
					}
				}
			}

			// Переключить видимость подзадач (рекурсивная)
			function toggleSubtasksRecursive(taskId, subtaskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task) {
					updateSubtaskRecursive(task.subtasks, subtaskId, subtask => {
						subtask.subtasksExpanded = !subtask.subtasksExpanded
					})
					renderTasks()
					saveCurrentProject()
				}
			}

			// Переключить статус подзадачи (рекурсивная)
			function toggleSubtaskRecursive(taskId, subtaskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task) {
					updateSubtaskRecursive(task.subtasks, subtaskId, subtask => {
						subtask.completed = !subtask.completed
					})
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
				}
			}

			// Удалить подзадачу (рекурсивная)
			function deleteSubtaskRecursive(taskId, subtaskId) {
				const task = tasks.find(t => t.id === taskId)
				if (task) {
					if (removeSubtaskRecursive(task.subtasks, subtaskId)) {
						renderTasks()
						updateStats()
						saveCurrentProject()
						showSaveIndicator()
						showNotification('Подзадача удалена!')
					}
				}
			}

			// Скрыть все формы подзадач
			function hideAllSubtaskForms() {
				const forms = document.querySelectorAll('.subtask-form')
				forms.forEach(form => {
					form.style.display = 'none'
				})
			}

			// Рекурсивная функция для рендеринга подзадач
			function renderSubtasksRecursive(subtasks, parentId, level = 0) {
				if (!subtasks || subtasks.length === 0) return ''

				const indent = level * 20
				return subtasks
					.map(subtask => {
						const hasSubtasks = subtask.subtasks && subtask.subtasks.length > 0
						const subtasksExpanded = subtask.subtasksExpanded || false
						const subtaskCount = hasSubtasks
							? countSubtasks(subtask.subtasks)
							: 0

						return `
						<div class="subtask-item ${
							subtask.completed ? 'completed' : ''
						}" style="margin-left: ${indent}px;">
							<div class="subtask-content">
								<div class="subtask-main">
									<input type="checkbox" 
										class="task-checkbox" 
										${subtask.completed ? 'checked' : ''} 
										onchange="toggleSubtaskRecursive('${parentId}', ${subtask.id})"
										style="margin-right: 12px; width: 16px; height: 16px; cursor: pointer;">
									${
										hasSubtasks
											? `<button class="subtask-expand ${
													subtasksExpanded ? '' : 'collapsed'
											  }" 
											onclick="toggleSubtasksRecursive('${parentId}', ${subtask.id})" 
											title="${subtaskCount} подзадач">
											▼ <span class="subtask-count">${subtaskCount}</span>
										   </button>`
											: '<span style="width: 24px;"></span>'
									}
									<span class="subtask-text" onclick="startSubtaskEdit('${parentId}', ${
							subtask.id
						})" 
										style="cursor: pointer; flex: 1;">${escapeHTML(subtask.text)}</span>
								</div>
								<div class="task-actions">
									<button class="task-btn delete-btn" onclick="deleteSubtaskRecursive('${parentId}', ${
							subtask.id
						})">
										Удалить
									</button>
								</div>
							</div>
							
							${
								hasSubtasks
									? `
								<div class="subtasks-container ${
									subtasksExpanded ? 'show' : ''
								}" id="subtasks_${parentId}_${subtask.id}">
									${renderSubtasksRecursive(subtask.subtasks, parentId, level + 1)}
								</div>
							`
									: ''
							}
						</div>
					`
					})
					.join('')
			}

			// Удаляем дублированную функцию - используем только исправленную версию выше

			// Функции для редактирования задач
			function editTask(taskId) {
				// Скрываем все другие формы
				hideAllSubtaskForms()
				hideAllEditForms()

				const form = document.getElementById(`editForm_${taskId}`)
				if (form) {
					form.style.display = 'flex'
					const input = document.getElementById(`editInput_${taskId}`)
					if (input) {
						input.focus()
						input.select()
					}
				}
			}

			// Начало редактирования задачи по клику
			function startTaskEdit(taskId) {
				// Скрываем все другие формы
				hideAllSubtaskForms()
				hideAllEditForms()

				const form = document.getElementById(`editForm_${taskId}`)
				if (form) {
					form.style.display = 'flex'
					const input = document.getElementById(`editInput_${taskId}`)
					if (input) {
						input.focus()
						input.select()
					}
				}
			}

			// Начало редактирования подзадачи по клику
			function startSubtaskEdit(parentId, subtaskId) {
				const subtaskText = document.querySelector(
					`[onclick="startSubtaskEdit('${parentId}', ${subtaskId})"]`
				)
				if (!subtaskText) return

				const currentText = subtaskText.textContent
				const input = document.createElement('input')
				input.type = 'text'
				input.className = 'subtask-input'
				input.value = currentText
				input.style.cssText =
					'margin: 0; padding: 8px; border: 2px solid #fc403a; border-radius: 5px; background: white;'

				subtaskText.style.display = 'none'
				subtaskText.parentNode.insertBefore(input, subtaskText.nextSibling)

				input.focus()
				input.select()

				function saveEdit() {
					const newText = input.value.trim()
					if (newText && newText !== currentText) {
						const task = tasks.find(t => t.id == parentId)
						if (task && task.subtasks) {
							const subtask = findSubtaskRecursive(task.subtasks, subtaskId)
							if (subtask) {
								subtask.text = newText
								renderTasks()
								updateStats()
								saveCurrentProject()
								showSaveIndicator()
								showNotification('Подзадача обновлена!')
								return
							}
						}
					}
					subtaskText.style.display = ''
					input.remove()
				}

				function cancelEdit() {
					subtaskText.style.display = ''
					input.remove()
				}

				input.addEventListener('keydown', e => {
					if (e.key === 'Enter') {
						e.preventDefault()
						saveEdit()
					} else if (e.key === 'Escape') {
						e.preventDefault()
						cancelEdit()
					}
				})

				input.addEventListener('blur', saveEdit)
			}

			function saveTaskEdit(taskId) {
				const input = document.getElementById(`editInput_${taskId}`)
				const newText = input.value.trim()

				if (!newText) {
					showNotification('Название задачи не может быть пустым!')
					return
				}

				const task = tasks.find(t => t.id === taskId)
				if (task) {
					task.text = newText
					cancelTaskEdit(taskId)
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Задача обновлена!')
				}
			}

			function cancelTaskEdit(taskId) {
				const form = document.getElementById(`editForm_${taskId}`)
				if (form) {
					form.style.display = 'none'
				}
			}

			function hideAllEditForms() {
				const forms = document.querySelectorAll('[id^="editForm_"]')
				forms.forEach(form => {
					form.style.display = 'none'
				})
			}

			// Отображение задач (с рекурсивными подзадачами)
			function renderTasks() {
				const taskList = document.getElementById('taskList')
				if (!taskList) return

				taskList.innerHTML = ''

				tasks.forEach(task => {
					const li = document.createElement('li')
					li.className = `task-item ${task.completed ? 'completed' : ''}`

					const hasSubtasks = task.subtasks && task.subtasks.length > 0
					const subtasksExpanded = task.subtasksExpanded || false
					const subtaskCount = hasSubtasks ? countSubtasks(task.subtasks) : 0

					li.innerHTML = `
						<div class="task-content">
							<div class="task-main">
								<input type="checkbox" 
									class="task-checkbox" 
									${task.completed ? 'checked' : ''} 
									onchange="toggleTask(${task.id})"
									style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
								${
									hasSubtasks
										? `<button class="task-expand ${
												subtasksExpanded ? '' : 'collapsed'
										  }" 
										onclick="toggleSubtasks(${task.id})" 
										title="${subtaskCount} подзадач">
										▼ <span class="subtask-count">${subtaskCount}</span>
									</button>`
										: '<span style="width: 24px;"></span>'
								}
								<span class="task-text" onclick="startTaskEdit(${task.id})" 
									style="cursor: pointer; flex: 1;">${escapeHTML(task.text)}</span>
							</div>
							<div class="task-actions">
								<button class="task-btn subtask-btn" onclick="showSubtaskForm(${task.id})">
									Подзадача
								</button>
								<button class="task-btn delete-btn" onclick="deleteTask(${task.id})">
									Удалить
								</button>
							</div>
						</div>
						
						<div class="subtask-form" id="subtaskForm_${task.id}">
							<input type="text" class="subtask-input" id="subtaskInput_${task.id}" 
								placeholder="Введите подзадачу..." 
								onkeypress="if(event.key==='Enter'){addSubtask(${task.id})}">
							<button class="add-subtask-btn" onclick="addSubtask(${
								task.id
							})">Добавить</button>
							<button class="add-subtask-btn subtask-btn" onclick="hideSubtaskForm(${
								task.id
							})">Отмена</button>
						</div>
						
						<div class="subtask-form" id="editForm_${task.id}" style="display: none;">
							<input type="text" class="subtask-input" id="editInput_${task.id}" 
								placeholder="Редактировать задачу..." 
								value="${escapeHTML(task.text)}"
								onkeypress="if(event.key==='Enter'){saveTaskEdit(${task.id})}">
							<button class="add-subtask-btn" onclick="saveTaskEdit(${
								task.id
							})">Сохранить</button>
							<button class="add-subtask-btn subtask-btn" onclick="cancelTaskEdit(${
								task.id
							})">Отмена</button>
						</div>
						
						${
							hasSubtasks
								? `
							<div class="subtasks-container ${
								subtasksExpanded ? 'show' : ''
							}" id="subtasks_${task.id}">
								${renderSubtasksRecursive(task.subtasks, task.id)}
							</div>
						`
								: ''
						}
					`
					taskList.appendChild(li)
				})
			}

			// Переключение статуса задачи
			function toggleTask(id) {
				const task = tasks.find(t => t.id === id)
				if (task) {
					task.completed = !task.completed
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
				}
			}

			// Удаление задачи
			function deleteTask(id) {
				const index = tasks.findIndex(t => t.id === id)
				if (index !== -1) {
					tasks.splice(index, 1)
					renderTasks()
					updateStats()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Задача удалена!')
				}
			}

			// Функции уведомлений и индикаторов
			function showNotification(message) {
				const notification = document.createElement('div')
				notification.className = 'notification'
				notification.textContent = message
				notification.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: linear-gradient(135deg, #fc403a 0%, #e63946 100%);
					color: white;
					padding: 12px 20px;
					border-radius: 8px;
					box-shadow: 0 4px 15px rgba(252, 64, 58, 0.3);
					z-index: 10000;
					font-weight: 500;
					transform: translateX(100%);
					transition: transform 0.3s ease;
				`

				document.body.appendChild(notification)

				setTimeout(() => {
					notification.style.transform = 'translateX(0)'
				}, 100)

				setTimeout(() => {
					notification.style.transform = 'translateX(100%)'
					setTimeout(() => {
						if (notification.parentNode) {
							notification.parentNode.removeChild(notification)
						}
					}, 300)
				}, 3000)
			}

			function showSaveIndicator() {
				const indicator = document.getElementById('saveIndicator')
				if (indicator) {
					indicator.style.display = 'block'
					setTimeout(() => {
						indicator.style.display = 'none'
					}, 2000)
				}
			}

			function showLoadingIndicator(message = 'Загрузка...') {
				let indicator = document.getElementById('loadingIndicator')
				if (!indicator) {
					indicator = document.createElement('div')
					indicator.id = 'loadingIndicator'
					indicator.style.cssText = `
						position: fixed;
						top: 50%;
						left: 50%;
						transform: translate(-50%, -50%);
						background: rgba(19, 9, 9, 0.9);
						color: white;
						padding: 20px 30px;
						border-radius: 10px;
						z-index: 10000;
						font-weight: 500;
						backdrop-filter: blur(10px);
					`
					document.body.appendChild(indicator)
				}
				indicator.textContent = message
				indicator.style.display = 'block'
			}

			function hideLoadingIndicator() {
				const indicator = document.getElementById('loadingIndicator')
				if (indicator) {
					indicator.style.display = 'none'
				}
			}

			function showConnectionStatus() {
				const status = document.getElementById('connectionStatus')
				if (status) {
					status.style.display = 'block'
				}
			}
			function updateConnectionStatus() {
				const status = document.getElementById('connectionStatus')
				if (status) {
					if (isFirebaseAvailable) {
						status.innerHTML = '☁️ Синхронизация с облаком'
						status.style.background =
							'linear-gradient(135deg, #28a745 0%, #20c997 100%)'
					} else {
						status.innerHTML = '💾 Локальное сохранение'
						status.style.background =
							'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)'
					}
				}
			}

			// Обновление статистики проекта
			function updateStats() {
				if (!currentProject || !projects[currentProject]) return

				const totalTasks = tasks.length
				const completedTasks = tasks.filter(task => task.completed).length
				const pendingTasks = totalTasks - completedTasks
				const totalSubtasks = tasks.reduce(
					(sum, task) => sum + (task.subtasks ? task.subtasks.length : 0),
					0
				)
				const completedSubtasks = tasks.reduce((sum, task) => {
					if (task.subtasks) {
						return (
							sum + task.subtasks.filter(subtask => subtask.completed).length
						)
					}
					return sum
				}, 0)

				const totalItems = totalTasks + totalSubtasks
				const completedItems = completedTasks + completedSubtasks
				const progressPercent =
					totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0

				// Обновляем элементы статистики
				const totalTasksElement = document.getElementById('totalTasks')
				const completedTasksElement = document.getElementById('completedTasks')
				const pendingTasksElement = document.getElementById('pendingTasks')
				const completionRateElement = document.getElementById('completionRate')
				const totalNotesElement = document.getElementById('totalNotes')
				const progressTextElement = document.getElementById('progressText')
				const progressFillElement = document.getElementById('progressFill')

				if (totalTasksElement) totalTasksElement.textContent = totalTasks
				if (completedTasksElement)
					completedTasksElement.textContent = completedTasks
				if (pendingTasksElement) pendingTasksElement.textContent = pendingTasks
				if (completionRateElement)
					completionRateElement.textContent = `${progressPercent}%`
				if (totalNotesElement) totalNotesElement.textContent = notes.length
				if (progressTextElement)
					progressTextElement.textContent = `${progressPercent}%`
				if (progressFillElement)
					progressFillElement.style.width = `${progressPercent}%`

				console.log('Статистика обновлена:', {
					totalTasks,
					completedTasks,
					pendingTasks,
					totalSubtasks,
					completedSubtasks,
					progressPercent,
					notesCount: notes.length,
				})
			}

			// Функции для работы с заметками
			function addNote() {
				const input = document.getElementById('notesInput')
				const noteText = input.value.trim()

				if (noteText && currentProject) {
					const newNote = {
						id: Date.now(),
						text: noteText,
						createdAt: new Date().toISOString(),
					}

					notes.unshift(newNote)
					input.value = ''
					input.focus()
					renderNotes()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Заметка добавлена!')
				}
			}

			function renderNotes() {
				const notesList = document.getElementById('notesList')
				if (!notesList) return

				notesList.innerHTML = ''

				notes.forEach(note => {
					const noteDiv = document.createElement('div')
					noteDiv.className = 'note-item'
					noteDiv.innerHTML = `
						<div class="note-content">
							<span class="note-text">${escapeHTML(note.text)}</span>
							<button class="note-delete-btn" onclick="deleteNote(${note.id})">×</button>
						</div>
						<div class="note-date">${new Date(note.createdAt).toLocaleString('ru-RU')}</div>
					`
					notesList.appendChild(noteDiv)
				})
			}

			function deleteNote(noteId) {
				const index = notes.findIndex(n => n.id === noteId)
				if (index !== -1) {
					notes.splice(index, 1)
					renderNotes()
					saveCurrentProject()
					showSaveIndicator()
					showNotification('Заметка удалена!')
				}
			}

			// Функции для работы с гипотезами
			let hypotheses = []

			// Загрузка гипотез из Firebase/localStorage
			async function loadHypotheses() {
				try {
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						hypotheses = []
						return
					}

					// Если Firebase доступен, загружаем из облака
					if (isFirebaseAvailable && db) {
						console.log(
							`Загрузка гипотез из Firebase для пользователя: ${userEmail}`
						)
						const snapshot = await db
							.collection('hypotheses')
							.where('owner', '==', userEmail)
							.orderBy('createdAt', 'desc')
							.get()
						const cloudHypotheses = []
						snapshot.forEach(doc => {
							cloudHypotheses.push({ id: doc.id, ...doc.data() })
						})

						// Дублируем в localStorage как backup
						localStorage.setItem(
							`hypotheses_${userEmail}`,
							JSON.stringify(cloudHypotheses)
						)
						hypotheses = cloudHypotheses
						console.log(
							`Гипотезы пользователя ${userEmail} загружены из Firebase:`,
							hypotheses.length
						)
						return
					}
				} catch (error) {
					console.error('Ошибка загрузки гипотез из Firebase:', error)
				}

				// Fallback к localStorage
				const userEmail = localStorage.getItem('userEmail')
				console.log(
					`Загрузка гипотез из localStorage для пользователя: ${userEmail}`
				)
				hypotheses = JSON.parse(
					localStorage.getItem(`hypotheses_${userEmail}`) || '[]'
				)
			}

			// Сохранение гипотезы в Firebase/localStorage
			async function saveHypothesis(hypothesis) {
				try {
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						return
					}

					// Добавляем владельца к гипотезе
					const hypothesisWithOwner = {
						...hypothesis,
						owner: userEmail,
					}

					// Если Firebase доступен, сохраняем в облако
					if (isFirebaseAvailable && db) {
						console.log('Сохранение гипотезы в Firebase:', hypothesis.text)
						await db
							.collection('hypotheses')
							.doc(hypothesis.id.toString())
							.set(hypothesisWithOwner)
						console.log('Гипотеза сохранена в Firebase')
					}

					// Всегда дублируем в localStorage как backup
					localStorage.setItem(
						`hypotheses_${userEmail}`,
						JSON.stringify(hypotheses)
					)
					console.log('Гипотеза сохранена в localStorage')
				} catch (error) {
					console.error('Ошибка сохранения гипотезы:', error)
					// При ошибке Firebase все равно сохраняем в localStorage
					const userEmail = localStorage.getItem('userEmail')
					localStorage.setItem(
						`hypotheses_${userEmail}`,
						JSON.stringify(hypotheses)
					)
				}
			}

			// Удаление гипотезы из Firebase/localStorage
			async function removeHypothesisFromCloud(hypothesisId) {
				try {
					const userEmail = localStorage.getItem('userEmail')
					if (!userEmail) {
						console.error('Нет данных о текущем пользователе')
						return
					}

					// Если Firebase доступен, удаляем из облака
					if (isFirebaseAvailable && db) {
						console.log('Удаление гипотезы из Firebase:', hypothesisId)
						await db
							.collection('hypotheses')
							.doc(hypothesisId.toString())
							.delete()
						console.log('Гипотеза удалена из Firebase')
					}

					// Всегда обновляем localStorage
					localStorage.setItem(
						`hypotheses_${userEmail}`,
						JSON.stringify(hypotheses)
					)
					console.log('Гипотеза удалена из localStorage')
				} catch (error) {
					console.error('Ошибка удаления гипотезы:', error)
					// При ошибке Firebase все равно обновляем localStorage
					const userEmail = localStorage.getItem('userEmail')
					localStorage.setItem(
						`hypotheses_${userEmail}`,
						JSON.stringify(hypotheses)
					)
				}
			}

			async function addHypothesis() {
				const input = document.getElementById('hypothesisInput')
				const hypothesisText = input.value.trim()

				if (hypothesisText) {
					const newHypothesis = {
						id: Date.now(),
						text: hypothesisText,
						createdAt: new Date().toISOString(),
					}

					hypotheses.unshift(newHypothesis)
					input.value = ''
					renderHypotheses()

					// Сохранение в облако
					await saveHypothesis(newHypothesis)
					showNotification('Гипотеза добавлена!')
				}
			}

			function renderHypotheses() {
				const hypothesesList = document.getElementById('hypothesesList')
				if (!hypothesesList) return

				hypothesesList.innerHTML = ''

				hypotheses.forEach(hypothesis => {
					const hypothesisDiv = document.createElement('div')
					hypothesisDiv.className = 'hypothesis-item'
					hypothesisDiv.innerHTML = `
						<div class="hypothesis-content">
							<span class="hypothesis-text">${escapeHTML(hypothesis.text)}</span>
							<button class="hypothesis-delete-btn" onclick="deleteHypothesis(${
								hypothesis.id
							})">×</button>
						</div>
						<div class="hypothesis-date">${new Date(hypothesis.createdAt).toLocaleString(
							'ru-RU'
						)}</div>
					`
					hypothesesList.appendChild(hypothesisDiv)
				})
			}

			async function deleteHypothesis(hypothesisId) {
				const index = hypotheses.findIndex(h => h.id === hypothesisId)
				if (index !== -1) {
					hypotheses.splice(index, 1)
					renderHypotheses()

					// Удаление из облака
					await removeHypothesisFromCloud(hypothesisId)
					showNotification('Гипотеза удалена!')
				}
			}

			// Функции для работы с цветами проектов
			function showColorPicker(projectId) {
				const colorPicker = document.getElementById('colorPicker')
				const colorPickerProject = document.getElementById('colorPickerProject')

				colorPickerProject.value = projectId
				colorPicker.style.display = 'block'

				// Показать текущий цвет проекта
				const project = projects[projectId]
				if (project && project.color) {
					const colorButtons = colorPicker.querySelectorAll('.color-option')
					colorButtons.forEach(btn => btn.classList.remove('selected'))
					const currentColorBtn = colorPicker.querySelector(
						`[data-color="${project.color}"]`
					)
					if (currentColorBtn) {
						currentColorBtn.classList.add('selected')
					}
				}
			}

			function hideColorPicker() {
				const colorPicker = document.getElementById('colorPicker')
				colorPicker.style.display = 'none'
			}

			function selectProjectColor(color) {
				const colorPickerProject = document.getElementById('colorPickerProject')
				const projectId = colorPickerProject.value

				if (projectId && projects[projectId]) {
					projects[projectId].color = color
					hideColorPicker()
					renderProjectsList()
					saveProject(projectId, projects[projectId])
					showNotification('Цвет проекта изменен!')
				}
			}

			// Инициализация гипотез при загрузке
			document.addEventListener('DOMContentLoaded', function () {
				renderHypotheses()
			})

			// ...existing code...
		</script>
	</body>
</html>
